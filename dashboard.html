<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background: #f2f2f7;
            min-height: 100vh;
            padding: 48px 24px 64px;
            color: #1c1c1e;
        }

        /* â”€â”€ En-tÃªte â”€â”€ */
        header {
            max-width: 960px;
            margin: 0 auto 36px;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        header h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #1c1c1e;
        }

        header p {
            margin-top: 6px;
            font-size: 15px;
            color: #8e8e93;
            font-weight: 400;
        }

        /* Badge total */
        .badge-total {
            background: #1c1c1e;
            color: #fff;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 14px;
            font-weight: 600;
            align-self: center;
            white-space: nowrap;
        }

        /* Indicateur de sync */
        .sync-status {
            max-width: 960px;
            margin: -20px auto 20px;
            font-size: 12px;
            color: #aeaeb2;
            text-align: right;
        }

        .sync-status.erreur {
            color: #ff3b30;
        }

        /* â”€â”€ Grille catÃ©gories â”€â”€ */
        .grid {
            max-width: 960px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 14px;
        }

        /* â”€â”€ Carte â”€â”€ */
        .card {
            background: #ffffff;
            border-radius: 18px;
            padding: 22px 20px 20px;
            border-top: 4px solid var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            cursor: default;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.09);
        }

        .card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        /* Compteur */
        .card-count {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: -1px;
            color: #1c1c1e;
            line-height: 1;
            margin-bottom: 8px;
            transition: opacity 0.2s;
        }

        .card-count.chargement {
            opacity: 0.3;
        }

        /* LibellÃ© */
        .card-label {
            font-size: 13px;
            font-weight: 500;
            color: #3c3c43;
            line-height: 1.4;
        }

        /* â”€â”€ Couleurs accent â”€â”€ */
        .c-orange  { --accent: #ff9500; }
        .c-yellow  { --accent: #ffcc00; }
        .c-purple  { --accent: #af52de; }
        .c-red     { --accent: #ff3b30; }
        .c-teal    { --accent: #5ac8fa; }
        .c-blue    { --accent: #007aff; }
        .c-green   { --accent: #34c759; }
        .c-pink    { --accent: #ff2d55; }
        .c-indigo  { --accent: #5856d6; }
        .c-gray    { --accent: #8e8e93; }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 480px) {
            body { padding: 32px 16px 48px; }
            header h1 { font-size: 28px; }
            .grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .card { padding: 16px 14px 14px; }
            .card-count { font-size: 32px; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>CatÃ©gories</h1>
        <p>Vue d'ensemble des commandes</p>
    </div>
    <div class="badge-total" id="badge-total">â€” commandes</div>
</header>

<div class="sync-status" id="sync-status">Chargementâ€¦</div>

<div class="grid">

    <div class="card c-orange">
        <div class="card-count chargement" id="stat-en_attente">â€”</div>
        <div class="card-label">Commande en attente</div>
    </div>

    <div class="card c-yellow">
        <div class="card-count chargement" id="stat-a_preparer">â€”</div>
        <div class="card-label">Commande Ã  prÃ©parer</div>
    </div>

    <div class="card c-purple">
        <div class="card-count chargement" id="stat-maquette_a_faire">â€”</div>
        <div class="card-label">Maquette Ã  faire</div>
    </div>

    <div class="card c-red">
        <div class="card-count chargement" id="stat-prt_a_faire">â€”</div>
        <div class="card-label">PRT Ã  faire</div>
    </div>

    <div class="card c-teal">
        <div class="card-count chargement" id="stat-validation">â€”</div>
        <div class="card-label">En attente de validation</div>
    </div>

    <div class="card c-blue">
        <div class="card-count chargement" id="stat-impression">â€”</div>
        <div class="card-label">En cours d'impression</div>
    </div>

    <div class="card c-green">
        <div class="card-count chargement" id="stat-pressage">â€”</div>
        <div class="card-label">Pressage Ã  faire</div>
    </div>

    <div class="card c-pink">
        <div class="card-count chargement" id="stat-client_a_contacter">â€”</div>
        <div class="card-label">Client Ã  contacter</div>
    </div>

    <div class="card c-indigo">
        <div class="card-count chargement" id="stat-client_prevenu">â€”</div>
        <div class="card-label">Client prÃ©venu</div>
    </div>

    <div class="card c-gray">
        <div class="card-count chargement" id="stat-archives">â€”</div>
        <div class="card-label">Archives</div>
    </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const STATS_IDS = [
        'en_attente', 'a_preparer', 'maquette_a_faire', 'prt_a_faire',
        'validation', 'impression', 'pressage', 'client_a_contacter',
        'client_prevenu', 'archives'
    ];

    function appliquerStats(data) {
        STATS_IDS.forEach(statut => {
            const el = document.getElementById('stat-' + statut);
            if (el) {
                el.textContent = data.stats[statut] ?? 0;
                el.classList.remove('chargement');
            }
        });
        const badge = document.getElementById('badge-total');
        badge.textContent = data.total + ' commande' + (data.total !== 1 ? 's' : '');
    }

    function afficherSync(texte, erreur) {
        const sync = document.getElementById('sync-status');
        sync.textContent = texte;
        erreur ? sync.classList.add('erreur') : sync.classList.remove('erreur');
    }

    function heureNow() {
        return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    /* â”€â”€ Connexion Socket.io â”€â”€ */
    const socket = io({ transports: ['websocket', 'polling'] });

    socket.on('connect', () => {
        afficherSync('ConnectÃ© â€” en attente de commandesâ€¦', false);
    });

    socket.on('disconnect', () => {
        afficherSync('Connexion perdue â€” reconnexionâ€¦', true);
    });

    /* Mise Ã  jour instantanÃ©e des compteurs Ã  chaque commande reÃ§ue */
    socket.on('stats-update', (data) => {
        appliquerStats(data);
        afficherSync('Mis Ã  jour Ã  ' + heureNow(), false);
    });

    /* Notification visuelle Ã  chaque nouvelle commande */
    socket.on('new-order', (order) => {
        const notif = document.createElement('div');
        notif.style.cssText = [
            'position:fixed', 'bottom:24px', 'left:50%', 'transform:translateX(-50%)',
            'background:#1c1c1e', 'color:#fff', 'padding:14px 22px',
            'border-radius:14px', 'font-size:14px', 'font-weight:600',
            'box-shadow:0 4px 20px rgba(0,0,0,0.3)', 'z-index:9999',
            'animation:fadeIn .25s ease'
        ].join(';');
        notif.textContent = 'ðŸ†• Nouvelle commande â€” ' + order.nom + ' (' + order.commande + ')';
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 4500);
    });

    /* â”€â”€ Fallback HTTP : chargement initial si socket lent â”€â”€ */
    async function chargerStatsFallback() {
        try {
            const resp = await fetch('/api/stats');
            if (!resp.ok) return;
            const data = await resp.json();
            appliquerStats(data);
            afficherSync('ChargÃ© Ã  ' + heureNow(), false);
        } catch (_) { /* socket prend le relais */ }
    }
    chargerStatsFallback();
</script>
<style>
    @keyframes fadeIn { from { opacity:0; transform:translateX(-50%) translateY(8px); } to { opacity:1; transform:translateX(-50%) translateY(0); } }
</style>

</body>
</html>
