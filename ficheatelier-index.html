<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Olda Studio — Atelier</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,300..900;1,14..32,300..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
            background: #000; color: #fff;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Mosaic grid ── */
        .mosaic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
        }
        @media (min-width: 768px) {
            .mosaic-grid { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
        }

        .mosaic-tile {
            background: #1c1c1e; border-radius: 20px;
            border: 1px solid #2c2c2e;
            overflow: hidden; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .mosaic-tile:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.6); border-color: #3a3a3c; }
        .mosaic-tile:active { transform: scale(0.97); }

        .mosaic-header { padding: 16px 16px 12px; }

        .mosaic-mockups {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px;
            background: #2c2c2e;
        }
        .mosaic-mockup-side {
            background: #111; padding: 8px;
            display: flex; flex-direction: column; align-items: center;
        }
        .mosaic-mockup-side img {
            width: 100%; height: auto; border-radius: 8px;
            background: #F5F5F7; object-fit: contain;
        }
        .mosaic-mockup-side .side-label {
            margin-top: 4px; font-size: 9px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1.5px; color: #555;
        }
        .mosaic-placeholder {
            background: #111; aspect-ratio: 2/1;
            display: flex; align-items: center; justify-content: center; color: #3a3a3c;
        }

        .mosaic-footer { padding: 10px 16px 14px; }

        /* ── Expanded overlay ── */
        .overlay {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85);
            -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px);
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .overlay.open { display: block; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .expanded-card {
            background: #1c1c1e; border-radius: 28px;
            border: 1px solid #2c2c2e;
            max-width: 600px; margin: 24px auto; overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .btn-whatsapp {
            background: #25D366; color: #fff; border-radius: 14px;
            padding: 16px; font-weight: 700; width: 100%; transition: 0.2s; cursor: pointer; border: none; font-size: 15px;
        }
        .btn-whatsapp:active { transform: scale(0.96); opacity: 0.8; }

        .btn-delete {
            background: #2c2c2e; color: #FF453A; border-radius: 14px;
            padding: 16px; font-weight: 700; transition: 0.2s; cursor: pointer; border: none; font-size: 15px;
            width: 100%;
        }
        .btn-delete:active { transform: scale(0.96); opacity: 0.8; }

        .btn-close-overlay {
            display: inline-flex; align-items: center; justify-content: center;
            background: #2c2c2e; color: #fff; border: none; border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer; transition: 0.2s; font-size: 20px;
        }
        .btn-close-overlay:active { transform: scale(0.9); opacity: 0.8; }

        .badge { padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-paid { background: rgba(52,199,89,0.15); color: #32D74B; }
        .badge-unpaid { background: rgba(255,69,58,0.15); color: #FF453A; }
        .badge-acompte { background: rgba(255,149,0,0.15); color: #FF9F0A; }
        .bio-tag { display:inline-flex; align-items:center; gap:3px; background:rgba(34,139,34,0.12); color:#1a6b32; font-size:9px; font-weight:700; letter-spacing:0.05em; padding:2px 6px 2px 5px; border-radius:10px; border:0.5px solid rgba(34,139,34,0.25); vertical-align:middle; margin-left:6px; }
        .ref-desc { font-size:11px; color:#8E8E93; margin-top:2px; }

        .loader { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ══════════════════════════════════════
           FICHE HAUT DE GAMME — Vue détail
           ══════════════════════════════════════ */
        .fiche-view { display: none; min-height: 100vh; padding: 20px 16px 40px; }
        .fiche-view.active { display: block; }

        /* ── Card principale ── */
        .fiche-card {
            background: #141414;
            border-radius: 28px;
            border: 1px solid rgba(255,255,255,0.08);
            max-width: 640px; margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 32px 80px rgba(0,0,0,0.7);
        }

        /* ── Bandeau marque ── */
        .fiche-brand {
            background: #0a0a0a;
            padding: 18px 28px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .fiche-brand-logo {
            font-size: 20px; font-weight: 900; letter-spacing: 6px;
            text-transform: uppercase; color: #fff;
        }
        .fiche-brand-logo span { color: #C9A84C; }
        .fiche-brand-ref {
            font-size: 11px; color: #555; font-weight: 700;
            letter-spacing: 2px; text-transform: uppercase; text-align: right;
        }

        /* ── Header client ── */
        .fiche-header {
            padding: 28px 28px 22px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .fiche-header-left h2 {
            font-size: 26px; font-weight: 800; letter-spacing: -0.5px;
            color: #fff; margin: 0 0 6px;
        }
        .fiche-header-left p {
            font-size: 14px; color: #86868b; margin: 0;
        }
        .fiche-header-right { text-align: right; }
        .fiche-header-right .fiche-date {
            font-size: 12px; color: #555; margin-top: 8px; font-weight: 500;
        }

        /* ── Mockups ── */
        .fiche-mockups {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1px; background: rgba(255,255,255,0.04);
        }
        .fiche-mockups .mockup-side {
            background: #0d0d0d; padding: 24px 16px 18px;
            display: flex; flex-direction: column; align-items: center;
        }
        .fiche-mockups img {
            width: 100%; max-width: 240px; height: auto;
            border-radius: 14px; object-fit: contain;
        }
        .fiche-mockups .side-label {
            margin-top: 10px; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 3px; color: #444;
        }

        /* ── Details table ── */
        .fiche-details { padding: 8px 28px 4px; }

        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 13px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label {
            font-size: 11px; color: #555; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; flex-shrink: 0;
        }
        .detail-value {
            font-size: 15px; font-weight: 600; text-align: right;
            color: #e5e5e5;
        }

        /* ── Note ── */
        .fiche-note {
            margin: 4px 28px 4px; padding: 16px 18px;
            background: rgba(255,255,255,0.03);
            border-radius: 14px; border: 1px solid rgba(255,255,255,0.06);
        }
        .fiche-note-label {
            font-size: 9px; color: #555; font-weight: 800;
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px;
        }
        .fiche-note p { font-size: 14px; color: #aaa; margin: 0; line-height: 1.5; }

        /* ── Total strip ── */
        .fiche-total-strip {
            margin: 16px 28px;
            background: rgba(201,168,76,0.07);
            border: 1px solid rgba(201,168,76,0.18);
            border-radius: 18px; padding: 20px 24px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .fiche-total-left { font-size: 11px; color: #C9A84C; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; }
        .fiche-total-sub { font-size: 12px; color: #555; margin-top: 4px; }
        .fiche-total-amount { font-size: 36px; font-weight: 900; color: #fff; letter-spacing: -1px; }

        /* ── Payment badge ── */
        .fiche-payment {
            margin: 0 28px 16px; padding: 14px 18px;
            border-radius: 14px; display: flex; align-items: center; gap: 12px;
        }
        .fiche-payment.pay-oui { background: rgba(52,199,89,0.08); border: 1px solid rgba(52,199,89,0.2); }
        .fiche-payment.pay-non { background: rgba(255,69,58,0.08); border: 1px solid rgba(255,69,58,0.2); }
        .fiche-payment.pay-acompte { background: rgba(255,149,0,0.08); border: 1px solid rgba(255,149,0,0.2); }
        .fiche-payment-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .pay-oui .fiche-payment-dot { background: #32D74B; box-shadow: 0 0 8px rgba(52,199,89,0.6); }
        .pay-non .fiche-payment-dot { background: #FF453A; box-shadow: 0 0 8px rgba(255,69,58,0.6); }
        .pay-acompte .fiche-payment-dot { background: #FF9F0A; box-shadow: 0 0 8px rgba(255,149,0,0.6); }
        .fiche-payment-label { font-size: 12px; color: #86868b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .fiche-payment-statut { font-size: 16px; font-weight: 800; }
        .pay-oui  .fiche-payment-statut { color: #32D74B; }
        .pay-non  .fiche-payment-statut { color: #FF453A; }
        .pay-acompte .fiche-payment-statut { color: #FF9F0A; }

        /* ── QR code section ── */
        .fiche-qr-section {
            margin: 4px 28px 20px;
            padding: 20px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 18px;
            display: flex; align-items: center; gap: 20px;
        }
        .fiche-qr-box {
            background: #fff; padding: 8px; border-radius: 10px;
            flex-shrink: 0; width: 90px; height: 90px;
            display: flex; align-items: center; justify-content: center;
        }
        #ficheQrCode canvas, #ficheQrCode img { border-radius: 6px; }
        .fiche-qr-text { }
        .fiche-qr-title {
            font-size: 13px; font-weight: 800; color: #fff;
            letter-spacing: -0.2px; margin-bottom: 4px;
        }
        .fiche-qr-sub { font-size: 11px; color: #555; line-height: 1.4; }

        /* ── WhatsApp button ── */
        .fiche-wa-wrap { padding: 4px 28px 32px; }

        /* ── Divider ── */
        .fiche-divider {
            height: 1px; background: rgba(255,255,255,0.05);
            margin: 4px 0;
        }

        /* ── Color dot ── */
        .color-dot {
            display: inline-block; width: 13px; height: 13px; border-radius: 50%;
            vertical-align: middle; margin-right: 6px;
            border: 1px solid rgba(255,255,255,0.12);
        }

        /* ── Back button ── */
        .btn-back {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.08); color: #fff; border: none;
            border-radius: 14px; padding: 12px 20px; font-weight: 600;
            font-size: 14px; cursor: pointer; transition: 0.2s; font-family: inherit;
            backdrop-filter: blur(10px);
        }
        .btn-back:active { transform: scale(0.96); opacity: 0.8; }

        /* ══════════════════════════════════════
           IMPRESSION — fiche haut de gamme
           ══════════════════════════════════════ */
        @media print {
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { background: #fff !important; color: #000 !important; margin: 0; }
            .fiche-view { padding: 0 !important; background: #fff; }
            .btn-back, #dashboardView, .fiche-wa-wrap,
            .overlay, .bs-backdrop { display: none !important; }

            .fiche-card {
                background: #fff !important; color: #000 !important;
                border-radius: 0 !important; border: none !important;
                box-shadow: none !important; max-width: 100% !important;
            }
            .fiche-brand { background: #000 !important; padding: 14px 28px; }
            .fiche-brand-logo { color: #fff !important; }
            .fiche-brand-logo span { color: #C9A84C !important; }
            .fiche-brand-ref { color: #aaa !important; }

            .fiche-header { border-bottom: 1px solid #ddd !important; }
            .fiche-header-left h2 { color: #000 !important; }
            .fiche-header-left p { color: #555 !important; }
            .fiche-header-right .fiche-date { color: #888 !important; }

            .fiche-mockups { background: #f0f0f0 !important; }
            .fiche-mockups .mockup-side { background: #fafafa !important; }
            .fiche-mockups .side-label { color: #999 !important; }

            .detail-label { color: #888 !important; }
            .detail-value { color: #000 !important; }
            .detail-row { border-bottom: 1px solid #eee !important; }

            .fiche-note { background: #f8f8f8 !important; border-color: #ddd !important; }
            .fiche-note-label { color: #999 !important; }
            .fiche-note p { color: #444 !important; }

            .fiche-total-strip {
                background: rgba(201,168,76,0.08) !important;
                border-color: rgba(201,168,76,0.35) !important;
            }
            .fiche-total-left { color: #A07830 !important; }
            .fiche-total-amount { color: #000 !important; }
            .fiche-total-sub { color: #888 !important; }

            .fiche-payment.pay-oui { background: rgba(52,199,89,0.06) !important; border-color: rgba(52,199,89,0.3) !important; }
            .fiche-payment.pay-non { background: rgba(255,69,58,0.06) !important; border-color: rgba(255,69,58,0.3) !important; }
            .fiche-payment.pay-acompte { background: rgba(255,149,0,0.06) !important; border-color: rgba(255,149,0,0.3) !important; }
            .fiche-payment-label { color: #666 !important; }

            .fiche-qr-section {
                background: #f8f8f8 !important; border-color: #ddd !important;
            }
            .fiche-qr-title { color: #000 !important; }
            .fiche-qr-sub { color: #888 !important; }
            .fiche-qr-box { border: 1px solid #ddd; }
        }

        /* ── Segmented tabs ── */
        .tabs { display:flex; gap:4px; background:#1c1c1e; border-radius:16px; padding:4px; margin-bottom:28px; }
        .tab-btn {
            flex:1; padding:10px 8px; border:none; border-radius:12px; font-size:13px;
            font-weight:700; font-family:inherit; cursor:pointer; transition:0.2s;
            background:transparent; color:#86868b;
        }
        .tab-btn.active { background:#2c2c2e; color:#fff; }
        .tab-count {
            display:inline-flex; align-items:center; justify-content:center;
            background:rgba(255,255,255,0.13); color:inherit; border-radius:8px;
            font-size:10px; font-weight:800; padding:1px 6px; margin-left:5px;
        }

        /* ── Bottom sheet Apple-style ── */
        .bs-backdrop {
            display:none; position:fixed; inset:0; z-index:300;
            background:rgba(0,0,0,0.72);
            -webkit-backdrop-filter:blur(14px); backdrop-filter:blur(14px);
            align-items:flex-end;
        }
        .bs-backdrop.open { display:flex; animation:fadeIn 0.2s ease; }
        .bs-sheet {
            background:#1c1c1e; border-radius:24px 24px 0 0;
            width:100%; max-width:600px; margin:0 auto;
            padding:8px 20px 44px; border-top:1px solid #2c2c2e;
            animation:slideUpSheet 0.38s cubic-bezier(0.16,1,0.3,1);
        }
        @keyframes slideUpSheet { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .bs-handle { width:36px; height:4px; border-radius:2px; background:#3a3a3c; margin:8px auto 28px; }

        /* ── WhatsApp button on fiche view ── */
        .btn-wa-fiche {
            display:flex; align-items:center; justify-content:center; gap:10px;
            background:#25D366; color:#fff; border:none; border-radius:18px;
            padding:18px 24px; font-size:17px; font-weight:700; font-family:inherit;
            width:100%; cursor:pointer; transition:0.18s; letter-spacing:-0.3px;
        }
        .btn-wa-fiche:active { transform:scale(0.97); opacity:0.85; }

        /* ── Tile status overlay ── */
        .mosaic-tile { position:relative; }
        .badge-contacted { background:rgba(10,132,255,0.15); color:#0A84FF; }
    </style>
</head>
<body>

<!-- ════════════════════════════════════
     DASHBOARD VIEW (existing)
     ════════════════════════════════════ -->
<div id="dashboardView" class="p-6 md:p-10">
    <header class="flex justify-between items-center mb-12">
        <div>
            <h1 class="text-4xl font-black tracking-tight">Olda Studio</h1>
            <p class="text-zinc-500 font-medium">Production textile en temps réel</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="loader" class="loader"></div>
            <button onclick="loadOrders()" class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded-full transition-colors cursor-pointer">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" id="tabActive" onclick="setTab('active')">
            En cours <span class="tab-count" id="tabActiveCount"></span>
        </button>
        <button class="tab-btn" id="tabContacted" onclick="setTab('contacted')">
            Clients contactés <span class="tab-count" id="tabContactedCount"></span>
        </button>
    </div>

    <!-- Mosaic grid -->
    <div id="mosaicGrid" class="mosaic-grid"></div>

    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-zinc-600">
        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" class="mb-4"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
        <p class="text-xl font-medium">Aucune commande en cours</p>
    </div>
</div>

<!-- ════════════════════════════════════
     EXPANDED OVERLAY
     ════════════════════════════════════ -->
<div id="expandedOverlay" class="overlay" onclick="if(event.target===this)fermerOverlay()">
    <div style="max-width:600px;margin:0 auto;padding:24px 16px 0;display:flex;justify-content:flex-end;">
        <button class="btn-close-overlay" onclick="fermerOverlay()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
    </div>
    <div id="expandedContent"></div>
</div>

<!-- ════════════════════════════════════
     BOTTOM SHEET — confirmation WhatsApp
     ════════════════════════════════════ -->
<div class="bs-backdrop" id="bsBackdrop" onclick="fermerBottomSheet()">
    <div class="bs-sheet" onclick="event.stopPropagation()">
        <div class="bs-handle"></div>
        <div style="text-align:center;margin-bottom:28px;">
            <div style="width:60px;height:60px;border-radius:50%;background:rgba(37,211,102,0.15);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
            </div>
            <h3 style="font-size:22px;font-weight:800;letter-spacing:-0.5px;color:#fff;">Client contacté ✓</h3>
            <p style="color:#86868b;font-size:15px;margin-top:8px;">Déplacer vers « Clients contactés » ?</p>
        </div>
        <button onclick="archiverFicheContactee()" style="background:#fff;color:#000;border:none;border-radius:16px;padding:18px;width:100%;font-size:17px;font-weight:700;font-family:inherit;cursor:pointer;margin-bottom:10px;letter-spacing:-0.3px;">Archiver</button>
        <button onclick="fermerBottomSheet()" style="background:#2c2c2e;color:#fff;border:none;border-radius:16px;padding:18px;width:100%;font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;letter-spacing:-0.3px;">Plus tard</button>
    </div>
</div>

<!-- ════════════════════════════════════
     FICHE VIEW (new — receives hash data)
     ════════════════════════════════════ -->
<div id="ficheView" class="fiche-view">
    <div style="max-width:600px;margin:0 auto 16px;">
        <button class="btn-back" onclick="goToDashboard()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Dashboard
        </button>
    </div>

    <div class="fiche-card">

        <!-- Bandeau marque -->
        <div class="fiche-brand">
            <div class="fiche-brand-logo">OLD<span>A</span> STUDIO</div>
            <div class="fiche-brand-ref" id="fCommande"></div>
        </div>

        <!-- Header client -->
        <div class="fiche-header">
            <div class="fiche-header-left">
                <h2 id="fNom"></h2>
                <p id="fTel"></p>
            </div>
            <div class="fiche-header-right">
                <span class="badge" id="fBadge"></span>
                <p class="fiche-date" id="fDate"></p>
                <p class="fiche-date" id="fDeadline" style="display:none;color:var(--accent,#007AFF);font-weight:700;"></p>
            </div>
        </div>

        <!-- Mockups haute résolution -->
        <div class="fiche-mockups" id="fMockupSection">
            <div class="mockup-side">
                <img id="fMockupFront" alt="Avant">
                <span class="side-label">Avant</span>
            </div>
            <div class="mockup-side">
                <img id="fMockupBack" alt="Arrière">
                <span class="side-label">Arrière</span>
            </div>
        </div>

        <div class="fiche-divider"></div>

        <!-- Détails commande -->
        <div class="fiche-details">
            <div class="detail-row">
                <span class="detail-label">Collection</span>
                <span class="detail-value" id="fCollection"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Référence</span>
                <span class="detail-value" id="fReference"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Taille</span>
                <span class="detail-value" id="fTaille"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Couleur</span>
                <span class="detail-value" id="fCouleur"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo avant</span>
                <span class="detail-value" id="fLogoAvant"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo arrière</span>
                <span class="detail-value" id="fLogoArriere"></span>
            </div>
            <div class="detail-row" id="fLogoArMmRow" style="display:none">
                <span class="detail-label">Côte logo Ar</span>
                <span class="detail-value" id="fLogoArMm"></span>
            </div>
        </div>

        <!-- Note -->
        <div class="fiche-note" id="fNoteSection" style="display:none">
            <div class="fiche-note-label">Note atelier</div>
            <p id="fNote"></p>
        </div>

        <div class="fiche-divider" style="margin:12px 0 0"></div>

        <!-- Total -->
        <div class="fiche-total-strip">
            <div>
                <div class="fiche-total-left">Total commande</div>
                <div class="fiche-total-sub">
                    T-Shirt <strong id="fPrixShirt"></strong> · Perso <strong id="fPrixPerso"></strong>
                </div>
            </div>
            <div class="fiche-total-amount" id="fTotal"></div>
        </div>

        <!-- Statut paiement -->
        <div class="fiche-payment" id="fPayment">
            <div class="fiche-payment-dot"></div>
            <div>
                <div class="fiche-payment-label" id="fPayLabel"></div>
                <div class="fiche-payment-statut" id="fPayStatut"></div>
            </div>
        </div>

        <div class="fiche-divider"></div>

        <!-- QR Code -->
        <div class="fiche-qr-section">
            <div class="fiche-qr-box">
                <div id="ficheQrCode"></div>
            </div>
            <div class="fiche-qr-text">
                <div class="fiche-qr-title">Scanner pour ouvrir la fiche</div>
                <div class="fiche-qr-sub">Scannez avec votre iPhone pour ouvrir cette fiche et envoyer un WhatsApp au client directement.</div>
            </div>
        </div>

        <!-- WhatsApp -->
        <div class="fiche-wa-wrap">
            <button class="btn-wa-fiche" id="fWaBtn" onclick="envoyerWhatsAppFiche()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Envoyer sur WhatsApp
            </button>
        </div>
    </div>
</div>

<script>
(function() {
'use strict';

/* ══════════════════════════════════════
   LOCAL STORAGE — persistence des fiches
   ══════════════════════════════════════ */
var STORAGE_KEY = 'olda_fiches';
var currentTab = 'active';   /* 'active' | 'contacted' */
var bsCurrentKey = '';       /* clé fiche en attente d'archivage */
var ficheViewKey = '';       /* clé fiche affichée dans ficheView */

function getAllFiches() {
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    } catch(e) { return {}; }
}

function saveFiche(f) {
    var fiches = getAllFiches();
    var key = f.commande || ('cmd-' + Date.now());
    /* Conserver le statut existant si la fiche est déjà enregistrée */
    if (fiches[key] && fiches[key].status) f.status = fiches[key].status;
    fiches[key] = f;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(fiches));
    return key;
}

function deleteFiche(key) {
    var fiches = getAllFiches();
    delete fiches[key];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(fiches));
}

/* ══════════════════════════════════════
   ROUTING — hash present → fiche / else → dashboard
   ══════════════════════════════════════ */
function route() {
    var hash = window.location.hash.slice(1);
    if (hash) {
        showFiche(hash);
    } else {
        showDashboard();
    }
}

function showDashboard() {
    document.getElementById('ficheView').classList.remove('active');
    document.getElementById('dashboardView').style.display = '';
    loadOrders();
}

window.goToDashboard = function() {
    history.pushState(null, '', window.location.pathname);
    fermerBottomSheet();
    ficheViewKey = '';
    showDashboard();
};

/* ══════════════════════════════════════
   FICHE DISPLAY
   ══════════════════════════════════════ */
function showFiche(encoded) {
    try {
        var json = decodeURIComponent(escape(atob(encoded)));
        var f = JSON.parse(json);
    } catch(e) {
        console.error('Decode error:', e);
        showDashboard();
        return;
    }

    /* Save fiche to localStorage */
    saveFiche(f);
    ficheViewKey = f.commande || '';

    document.getElementById('dashboardView').style.display = 'none';
    var view = document.getElementById('ficheView');
    view.classList.add('active');

    renderFicheDetail(f);
}

function showFicheFromStorage(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;

    ficheViewKey = key;
    document.getElementById('dashboardView').style.display = 'none';
    var view = document.getElementById('ficheView');
    view.classList.add('active');

    renderFicheDetail(f);
}

function renderFicheDetail(f) {
    /* Header */
    document.getElementById('fCommande').textContent = f.commande || '';
    document.getElementById('fNom').textContent = f.nom || '';
    document.getElementById('fTel').textContent = f.telephone || '';
    document.getElementById('fDate').textContent = f.date || '';

    /* Badge paiement */
    var badge = document.getElementById('fBadge');
    var statut = (f.paiement && f.paiement.statut) || 'NON';
    if (statut === 'OUI') {
        badge.textContent = 'PAYE'; badge.className = 'badge badge-paid';
    } else if (statut === 'ACOMPTE') {
        badge.textContent = 'ACOMPTE'; badge.className = 'badge badge-acompte';
    } else {
        badge.textContent = 'A REGLER'; badge.className = 'badge badge-unpaid';
    }

    /* Mockups — masquer si absents (fiche lite depuis Google Sheets) */
    var mockupSection = document.getElementById('fMockupSection');
    if (f.mockupFront) {
        mockupSection.style.display = '';
        document.getElementById('fMockupFront').src = f.mockupFront;
        document.getElementById('fMockupBack').src  = f.mockupBack || '';
    } else {
        mockupSection.style.display = 'none';
    }

    /* Details */
    document.getElementById('fCollection').textContent = f.collection || '\u2014';
    var refEl = document.getElementById('fReference');
    var refHtml = f.reference || '\u2014';
    if (f.bio) refHtml += '<span class="bio-tag"><svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24" fill="currentColor"><path d="M17 8C8 10 5.9 16.17 3.82 21.34L5.71 22l1-2.3A4.49 4.49 0 008 20C19 20 22 3 22 3c-1 2-8 2-8 2z"/></svg>BIO</span>';
    if (f.refDesc) refHtml += '<div class="ref-desc">' + f.refDesc + '</div>';
    refEl.innerHTML = refHtml;
    document.getElementById('fTaille').textContent = f.taille || '\u2014';

    var couleurHtml = '';
    if (f.couleur) {
        couleurHtml = '<span class="color-dot" style="background:' + (f.couleur.hex || '#fff') + '"></span>' + (f.couleur.nom || '');
    }
    document.getElementById('fCouleur').innerHTML = couleurHtml || '\u2014';

    document.getElementById('fLogoAvant').textContent =
        f.logoAvant ? (f.couleurLogoAvant ? f.logoAvant + ' / ' + f.couleurLogoAvant : f.logoAvant) : 'Aucun';
    document.getElementById('fLogoArriere').textContent =
        f.logoArriere ? (f.couleurLogoArriere ? f.logoArriere + ' / ' + f.couleurLogoArriere : f.logoArriere) : 'Aucun';

    var arMmRow = document.getElementById('fLogoArMmRow');
    var arMmEl  = document.getElementById('fLogoArMm');
    if (arMmRow) arMmRow.style.display = f.coteLogoAr ? '' : 'none';
    if (arMmEl && f.coteLogoAr) arMmEl.textContent = f.coteLogoAr + ' mm';

    var deadlineEl = document.getElementById('fDeadline');
    if (deadlineEl) {
        if (f.deadline) {
            var dp = f.deadline.split('-');
            var dfr = dp.length === 3 ? dp[2] + '/' + dp[1] + '/' + dp[0] : f.deadline;
            deadlineEl.textContent = '⏱ ' + dfr;
            deadlineEl.style.display = '';
        } else { deadlineEl.style.display = 'none'; }
    }

    /* Note */
    var noteSection = document.getElementById('fNoteSection');
    if (f.note && f.note.trim()) {
        noteSection.style.display = '';
        document.getElementById('fNote').textContent = f.note;
    } else {
        noteSection.style.display = 'none';
    }

    /* Payment block */
    var payDiv = document.getElementById('fPayment');
    payDiv.className = 'fiche-payment';
    if (statut === 'OUI') {
        payDiv.classList.add('pay-oui');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'PAYÉ';
    } else if (statut === 'ACOMPTE') {
        payDiv.classList.add('pay-acompte');
        document.getElementById('fPayLabel').textContent = 'Paiement partiel';
        document.getElementById('fPayStatut').textContent = 'ACOMPTE';
    } else {
        payDiv.classList.add('pay-non');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'À RÉGLER';
    }

    /* Prix */
    var prix = f.prix || {};
    var total = prix.total ? prix.total + ' €' : '0 €';
    document.getElementById('fTotal').textContent = total;
    document.getElementById('fPrixShirt').textContent = (prix.tshirt || '0') + ' €';
    document.getElementById('fPrixPerso').textContent = (prix.personnalisation || '0') + ' €';

    /* ── QR Code — URL légère sans mockups → scannable iPhone ── */
    var qrBox = document.getElementById('ficheQrCode');
    qrBox.innerHTML = '';
    try {
        var ficheLight = Object.assign({}, f);
        delete ficheLight.mockupFront;
        delete ficheLight.mockupBack;
        var lightEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(ficheLight))));
        var lightURL = 'https://ficheatelier.pages.dev/ficheatelier-index.html#' + lightEncoded;
        new QRCode(qrBox, {
            text     : lightURL,
            width    : 74,
            height   : 74,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });
    } catch(qrErr) { console.warn('QR Code:', qrErr); }
}

/* ══════════════════════════════════════
   WHATSAPP — format phone & send
   ══════════════════════════════════════ */
function formatPhone(tel) {
    if (!tel) return '';
    var cleaned = tel.replace(/[\s\-\.\(\)]/g, '');
    /* Si commence par 0, remplacer par +33 (France) */
    if (cleaned.charAt(0) === '0') cleaned = '33' + cleaned.slice(1);
    /* Retirer le + initial s'il existe */
    if (cleaned.charAt(0) === '+') cleaned = cleaned.slice(1);
    return cleaned;
}

function buildWaMessage(f) {
    var nom = f.nom || 'Client';
    var lignes = [];
    if (f.collection) lignes.push('✦ ' + f.collection + (f.reference ? ' · ' + f.reference : ''));
    if (f.taille)      lignes.push('✦ Taille ' + f.taille + (f.couleur && f.couleur.nom ? ' · ' + f.couleur.nom : ''));
    if (f.logoAvant && f.logoAvant !== 'Aucun')   lignes.push('✦ Logo avant : ' + f.logoAvant);
    if (f.logoArriere && f.logoArriere !== 'Aucun') lignes.push('✦ Logo arrière : ' + f.logoArriere);

    return 'Bonjour ' + nom + ' \uD83D\uDDA4\n\n' +
        'Votre commande OLDA est prête.\n' +
        lignes.join('\n') + '\n' +
        'ID ' + (f.commande || '') + '\n\n' +
        'Vous pouvez venir la r\u00E9cup\u00E9rer quand vous le souhaitez. \uD83D\uDE0A\n\n' +
        '\u2014 OLDA Studio';
}

window.envoyerWhatsApp = function(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;
    var url = 'https://wa.me/' + formatPhone(f.telephone) + '?text=' + encodeURIComponent(buildWaMessage(f));
    window.open(url, '_blank');
    /* Ouvrir le bottom sheet après un court délai */
    bsCurrentKey = key;
    setTimeout(ouvrirBottomSheet, 600);
};

window.envoyerWhatsAppFiche = function() {
    if (!ficheViewKey) return;
    var fiches = getAllFiches();
    var f = fiches[ficheViewKey];
    if (!f) return;
    var url = 'https://wa.me/' + formatPhone(f.telephone) + '?text=' + encodeURIComponent(buildWaMessage(f));
    window.open(url, '_blank');
    bsCurrentKey = ficheViewKey;
    setTimeout(ouvrirBottomSheet, 600);
};

window.setTab = function(tab) {
    currentTab = tab;
    document.getElementById('tabActive').classList.toggle('active', tab === 'active');
    document.getElementById('tabContacted').classList.toggle('active', tab === 'contacted');
    loadOrders();
};

function ouvrirBottomSheet() {
    document.getElementById('bsBackdrop').classList.add('open');
    document.body.style.overflow = 'hidden';
}

window.fermerBottomSheet = function() {
    document.getElementById('bsBackdrop').classList.remove('open');
    document.body.style.overflow = '';
    bsCurrentKey = '';
};

window.archiverFicheContactee = function() {
    if (!bsCurrentKey) return;
    var fiches = getAllFiches();
    if (fiches[bsCurrentKey]) {
        fiches[bsCurrentKey].status = 'contacted';
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fiches));
    }
    fermerBottomSheet();
    fermerOverlay();
    /* Revenir au dashboard sur l'onglet "Clients contactés" */
    goToDashboard();
    setTimeout(function() { setTab('contacted'); }, 80);
};

window.supprimerFiche = function(key) {
    if (!confirm('Supprimer cette fiche ?')) return;
    deleteFiche(key);
    fermerOverlay();
    loadOrders();
};

/* ══════════════════════════════════════
   OVERLAY — expand / close
   ══════════════════════════════════════ */
window.fermerOverlay = function() {
    document.getElementById('expandedOverlay').classList.remove('open');
    document.body.style.overflow = '';
};

window.ouvrirFiche = function(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;

    var statut = (f.paiement && f.paiement.statut) || 'NON';
    var badgeClass = statut === 'OUI' ? 'badge-paid' : (statut === 'ACOMPTE' ? 'badge-acompte' : 'badge-unpaid');
    var badgeText = statut === 'OUI' ? 'PAYE' : (statut === 'ACOMPTE' ? 'ACOMPTE' : 'A REGLER');
    var details = (f.collection || '') + ' · ' + (f.taille || '') + ' · ' + (f.couleur && f.couleur.nom || '');
    var ek = key.replace(/'/g, "\\'");

    var html =
        '<div class="expanded-card">' +
            '<div style="padding:28px 24px 20px;border-bottom:1px solid #2c2c2e;">' +
                '<div class="flex justify-between items-start">' +
                    '<div>' +
                        '<span class="text-[10px] text-zinc-500 font-black uppercase tracking-widest font-mono">' + (f.commande || '') + '</span>' +
                        '<h2 class="text-2xl font-bold mt-1 text-white">' + (f.nom || '') + '</h2>' +
                        '<p class="text-zinc-500 text-sm mt-1">' + (f.telephone || '') + '</p>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<span class="badge ' + badgeClass + '">' + badgeText + '</span>' +
                        '<p class="text-zinc-600 text-xs mt-2">' + (f.date || '') + '</p>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            (f.mockupFront ? '<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;background:#2c2c2e;">' +
                '<div style="background:#1c1c1e;padding:16px;display:flex;flex-direction:column;align-items:center;">' +
                    '<img src="' + f.mockupFront + '" style="width:100%;max-width:220px;height:auto;border-radius:12px;background:#F5F5F7;" alt="Avant">' +
                    '<span style="margin-top:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#86868b;">Avant</span>' +
                '</div>' +
                '<div style="background:#1c1c1e;padding:16px;display:flex;flex-direction:column;align-items:center;">' +
                    '<img src="' + (f.mockupBack || '') + '" style="width:100%;max-width:220px;height:auto;border-radius:12px;background:#F5F5F7;" alt="Arriere">' +
                    '<span style="margin-top:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#86868b;">Arriere</span>' +
                '</div>' +
            '</div>' : '') +
            '<div style="padding:24px;">' +
                '<div class="bg-zinc-900/50 rounded-xl p-4 text-sm border border-zinc-800/50 mb-4">' +
                    '<p class="text-zinc-400"><strong class="text-zinc-200">Config :</strong> ' + details + '</p>' +
                    '<p class="text-zinc-400 mt-1"><strong class="text-zinc-200">Logo :</strong> ' + (f.logoAvant || 'Aucun') + ' / ' + (f.logoArriere || 'Aucun') + '</p>' +
                    (f.note ? '<p class="text-zinc-400 mt-2 italic"><strong class="text-zinc-200">Notes :</strong> ' + f.note + '</p>' : '') +
                '</div>' +
                '<div class="flex gap-2 mb-3">' +
                    '<button onclick="voirFiche(\'' + ek + '\')" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl py-3 font-semibold text-sm cursor-pointer transition-colors">VOIR FICHE</button>' +
                    '<button onclick="envoyerWhatsApp(\'' + ek + '\')" class="flex-1 btn-whatsapp">' +
                        '<div class="flex items-center justify-center gap-2">' +
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>' +
                            '<span>WHATSAPP</span>' +
                        '</div>' +
                    '</button>' +
                '</div>' +
                '<button onclick="supprimerFiche(\'' + ek + '\')" class="btn-delete">' +
                    '<div class="flex items-center justify-center gap-2">' +
                        '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>' +
                        '<span>SUPPRIMER</span>' +
                    '</div>' +
                '</button>' +
            '</div>' +
        '</div>';

    document.getElementById('expandedContent').innerHTML = html;
    document.getElementById('expandedOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
};

/* ══════════════════════════════════════
   DASHBOARD — mosaic grid from localStorage
   ══════════════════════════════════════ */
window.loadOrders = function() {
    var loader = document.getElementById('loader');
    loader.style.display = 'block';

    var fiches = getAllFiches();
    var grid = document.getElementById('mosaicGrid');
    var empty = document.getElementById('emptyState');
    grid.innerHTML = '';

    var allKeys = Object.keys(fiches);

    /* Comptes par onglet */
    var nActive = 0, nContacted = 0;
    allKeys.forEach(function(k) {
        var s = fiches[k].status;
        if (!s || s === 'active') nActive++; else if (s === 'contacted') nContacted++;
    });
    var elA = document.getElementById('tabActiveCount');
    var elC = document.getElementById('tabContactedCount');
    if (elA) elA.textContent = nActive > 0 ? nActive : '';
    if (elC) elC.textContent = nContacted > 0 ? nContacted : '';

    /* Filtrage selon l'onglet courant */
    var filtered = allKeys.filter(function(k) {
        var s = fiches[k].status;
        if (currentTab === 'active') return !s || s === 'active';
        return s === 'contacted';
    });

    if (filtered.length === 0) {
        empty.classList.remove('hidden'); empty.classList.add('flex');
    } else {
        empty.classList.add('hidden'); empty.classList.remove('flex');

        filtered.slice().reverse().forEach(function(key) {
            var f = fiches[key];
            var statut = (f.paiement && f.paiement.statut) || 'NON';
            var badgeClass = statut === 'OUI' ? 'badge-paid' : (statut === 'ACOMPTE' ? 'badge-acompte' : 'badge-unpaid');
            var badgeText = statut === 'OUI' ? 'PAYÉ' : (statut === 'ACOMPTE' ? 'ACOMPTE' : 'À RÉGLER');
            var isContacted = f.status === 'contacted';

            var tile = document.createElement('div');
            tile.className = 'mosaic-tile';
            tile.onclick = function() { voirFiche(key); };

            tile.innerHTML =
                '<div class="mosaic-header">' +
                    '<p class="text-lg font-black text-white truncate">' + (f.nom || 'Sans nom') + '</p>' +
                    '<div class="flex items-center gap-2 mt-1">' +
                        '<span class="badge ' + badgeClass + '">' + badgeText + '</span>' +
                        (isContacted ? '<span class="badge badge-contacted">Contacté</span>' : '') +
                        '<span class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider">' + (f.commande || '') + '</span>' +
                    '</div>' +
                '</div>' +
                (f.mockupFront
                    ? '<div class="mosaic-mockups">' +
                        '<div class="mosaic-mockup-side">' +
                            '<img src="' + f.mockupFront + '" alt="Avant" loading="lazy">' +
                            '<span class="side-label">Avant</span>' +
                        '</div>' +
                        '<div class="mosaic-mockup-side">' +
                            '<img src="' + (f.mockupBack || '') + '" alt="Arrière" loading="lazy">' +
                            '<span class="side-label">Arrière</span>' +
                        '</div>' +
                      '</div>'
                    : '<div class="mosaic-placeholder">' +
                        '<svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>' +
                      '</div>') +
                '<div class="mosaic-footer">' +
                    '<p class="text-[11px] text-zinc-500 truncate">' + (f.collection || '') + ' · ' + (f.taille || '') + ' · ' + (f.couleur && f.couleur.nom || '') + '</p>' +
                '</div>';
            grid.appendChild(tile);
        });
    }

    loader.style.display = 'none';
};

window.voirFiche = function(key) {
    fermerOverlay();
    showFicheFromStorage(key);
};

/* ── Init ── */
route();
window.addEventListener('hashchange', route);

})();
</script>
</body>
</html>
