<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier — Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000; color: #fff;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Mosaic grid ── */
        .mosaic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }
        @media (min-width: 768px) {
            .mosaic-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        }

        .mosaic-tile {
            background: #1c1c1e; border-radius: 20px;
            border: 1px solid #2c2c2e;
            overflow: hidden; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        .mosaic-tile:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.6); border-color: #3a3a3c; }
        .mosaic-tile:active { transform: scale(0.97); }

        .mosaic-thumb {
            width: 100%; aspect-ratio: 1; object-fit: contain;
            background: #111; display: block;
        }
        .mosaic-info { padding: 12px 14px; }

        /* ── Expanded overlay ── */
        .overlay {
            display: none; position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.85);
            -webkit-backdrop-filter: blur(20px); backdrop-filter: blur(20px);
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .overlay.open { display: block; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .expanded-card {
            background: #1c1c1e; border-radius: 28px;
            border: 1px solid #2c2c2e;
            max-width: 600px; margin: 24px auto; overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .btn-whatsapp {
            background: #25D366; color: #fff; border-radius: 14px;
            padding: 16px; font-weight: 700; width: 100%; transition: 0.2s; cursor: pointer; border: none; font-size: 15px;
        }
        .btn-whatsapp:active { transform: scale(0.96); opacity: 0.8; }

        .btn-delete {
            background: #2c2c2e; color: #FF453A; border-radius: 14px;
            padding: 16px; font-weight: 700; transition: 0.2s; cursor: pointer; border: none; font-size: 15px;
            width: 100%;
        }
        .btn-delete:active { transform: scale(0.96); opacity: 0.8; }

        .btn-close-overlay {
            display: inline-flex; align-items: center; justify-content: center;
            background: #2c2c2e; color: #fff; border: none; border-radius: 50%;
            width: 40px; height: 40px; cursor: pointer; transition: 0.2s; font-size: 20px;
        }
        .btn-close-overlay:active { transform: scale(0.9); opacity: 0.8; }

        .badge { padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-paid { background: rgba(52,199,89,0.15); color: #32D74B; }
        .badge-unpaid { background: rgba(255,69,58,0.15); color: #FF453A; }
        .badge-acompte { background: rgba(255,149,0,0.15); color: #FF9F0A; }

        .loader { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Fiche detail view ── */
        .fiche-view { display: none; min-height: 100vh; padding: 20px; }
        .fiche-view.active { display: block; }

        .fiche-card {
            background: #1c1c1e; border-radius: 28px;
            border: 1px solid #2c2c2e;
            max-width: 600px; margin: 0 auto;
            overflow: hidden;
        }

        .fiche-header {
            padding: 28px 24px 20px;
            border-bottom: 1px solid #2c2c2e;
        }

        .fiche-mockups {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px;
            background: #2c2c2e;
        }
        .fiche-mockups .mockup-side {
            background: #1c1c1e; padding: 16px;
            display: flex; flex-direction: column; align-items: center;
        }
        .fiche-mockups img {
            width: 100%; max-width: 220px; height: auto;
            border-radius: 12px; background: #F5F5F7;
        }
        .fiche-mockups .side-label {
            margin-top: 8px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px; color: #86868b;
        }

        .fiche-details { padding: 24px; }

        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 13px; color: #86868b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-value { font-size: 15px; font-weight: 600; text-align: right; }

        .fiche-total {
            margin: 0 24px; padding: 24px 0;
            border-top: 1px solid #2c2c2e;
            text-align: center;
        }

        .fiche-note {
            margin: 0 24px 24px; padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 14px; border: 1px solid #2c2c2e;
        }

        .fiche-payment {
            margin: 0 24px 24px; padding: 20px;
            border-radius: 16px; text-align: center;
        }
        .fiche-payment.pay-oui { background: rgba(52,199,89,0.1); border: 1px solid rgba(52,199,89,0.25); }
        .fiche-payment.pay-non { background: rgba(255,69,58,0.1); border: 1px solid rgba(255,69,58,0.25); }
        .fiche-payment.pay-acompte { background: rgba(255,149,0,0.1); border: 1px solid rgba(255,149,0,0.25); }

        .color-dot {
            display: inline-block; width: 14px; height: 14px; border-radius: 50%;
            vertical-align: middle; margin-right: 6px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .btn-back {
            display: inline-flex; align-items: center; gap: 6px;
            background: #2c2c2e; color: #fff; border: none; border-radius: 14px;
            padding: 12px 20px; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: 0.2s; font-family: inherit;
        }
        .btn-back:active { transform: scale(0.96); opacity: 0.8; }

        @media print {
            body { background: #fff; color: #000; }
            .fiche-card { border: 2px solid #000; background: #fff; }
            .fiche-header { border-bottom: 2px solid #000; }
            .detail-label { color: #666; }
            .btn-back, #dashboardView { display: none !important; }
            .fiche-mockups { background: #eee; }
            .fiche-mockups .mockup-side { background: #fff; }
        }
    </style>
</head>
<body>

<!-- ════════════════════════════════════
     DASHBOARD VIEW (existing)
     ════════════════════════════════════ -->
<div id="dashboardView" class="p-6 md:p-10">
    <header class="flex justify-between items-center mb-12">
        <div>
            <h1 class="text-4xl font-black tracking-tight">Atelier</h1>
            <p class="text-zinc-500 font-medium">Production textile en temps reel</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="loader" class="loader"></div>
            <button onclick="loadOrders()" class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded-full transition-colors cursor-pointer">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </header>

    <!-- Mosaic grid -->
    <div id="mosaicGrid" class="mosaic-grid"></div>

    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-zinc-600">
        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" class="mb-4"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
        <p class="text-xl font-medium">Aucune commande en cours</p>
    </div>
</div>

<!-- ════════════════════════════════════
     EXPANDED OVERLAY
     ════════════════════════════════════ -->
<div id="expandedOverlay" class="overlay" onclick="if(event.target===this)fermerOverlay()">
    <div style="max-width:600px;margin:0 auto;padding:24px 16px 0;display:flex;justify-content:flex-end;">
        <button class="btn-close-overlay" onclick="fermerOverlay()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
    </div>
    <div id="expandedContent"></div>
</div>

<!-- ════════════════════════════════════
     FICHE VIEW (new — receives hash data)
     ════════════════════════════════════ -->
<div id="ficheView" class="fiche-view">
    <div style="max-width:600px;margin:0 auto 16px;">
        <button class="btn-back" onclick="goToDashboard()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Dashboard
        </button>
    </div>

    <div class="fiche-card">
        <!-- Header -->
        <div class="fiche-header">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] text-zinc-500 font-black uppercase tracking-widest" id="fCommande"></p>
                    <h2 class="text-2xl font-bold mt-1" id="fNom"></h2>
                    <p class="text-zinc-500 text-sm mt-1" id="fTel"></p>
                </div>
                <div class="text-right">
                    <span class="badge" id="fBadge"></span>
                    <p class="text-zinc-600 text-xs mt-2" id="fDate"></p>
                </div>
            </div>
        </div>

        <!-- Mockups -->
        <div class="fiche-mockups">
            <div class="mockup-side">
                <img id="fMockupFront" alt="Avant">
                <span class="side-label">Avant</span>
            </div>
            <div class="mockup-side">
                <img id="fMockupBack" alt="Arriere">
                <span class="side-label">Arriere</span>
            </div>
        </div>

        <!-- Details -->
        <div class="fiche-details">
            <div class="detail-row">
                <span class="detail-label">Collection</span>
                <span class="detail-value" id="fCollection"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Reference</span>
                <span class="detail-value" id="fReference"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Taille</span>
                <span class="detail-value" id="fTaille"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Couleur</span>
                <span class="detail-value" id="fCouleur"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo avant</span>
                <span class="detail-value" id="fLogoAvant"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo arriere</span>
                <span class="detail-value" id="fLogoArriere"></span>
            </div>
        </div>

        <!-- Note -->
        <div class="fiche-note" id="fNoteSection">
            <p class="text-[11px] text-zinc-500 font-bold uppercase tracking-wide mb-1">Note</p>
            <p class="text-sm text-zinc-300" id="fNote"></p>
        </div>

        <!-- Payment status -->
        <div class="fiche-payment" id="fPayment">
            <p class="text-[11px] font-bold uppercase tracking-wide mb-2 opacity-60" id="fPayLabel"></p>
            <p class="text-3xl font-black tracking-tight" id="fPayStatut"></p>
            <p class="text-sm mt-1 opacity-70" id="fPayAcompte"></p>
        </div>

        <!-- Total -->
        <div class="fiche-total">
            <p class="text-zinc-500 text-xs font-semibold uppercase tracking-wide mb-1">Total</p>
            <p class="text-5xl font-black tracking-tighter" id="fTotal"></p>
            <div class="flex justify-center gap-6 mt-2 text-xs text-zinc-600">
                <span>T-Shirt: <strong class="text-zinc-400" id="fPrixShirt"></strong></span>
                <span>Perso: <strong class="text-zinc-400" id="fPrixPerso"></strong></span>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
'use strict';

/* ══════════════════════════════════════
   LOCAL STORAGE — persistence des fiches
   ══════════════════════════════════════ */
var STORAGE_KEY = 'olda_fiches';

function getAllFiches() {
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    } catch(e) { return {}; }
}

function saveFiche(f) {
    var fiches = getAllFiches();
    var key = f.commande || ('cmd-' + Date.now());
    fiches[key] = f;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(fiches));
}

function deleteFiche(key) {
    var fiches = getAllFiches();
    delete fiches[key];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(fiches));
}

/* ══════════════════════════════════════
   ROUTING — hash present → fiche / else → dashboard
   ══════════════════════════════════════ */
function route() {
    var hash = window.location.hash.slice(1);
    if (hash) {
        showFiche(hash);
    } else {
        showDashboard();
    }
}

function showDashboard() {
    document.getElementById('ficheView').classList.remove('active');
    document.getElementById('dashboardView').style.display = '';
    loadOrders();
}

window.goToDashboard = function() {
    history.pushState(null, '', window.location.pathname);
    showDashboard();
};

/* ══════════════════════════════════════
   FICHE DISPLAY
   ══════════════════════════════════════ */
function showFiche(encoded) {
    try {
        var json = decodeURIComponent(escape(atob(encoded)));
        var f = JSON.parse(json);
    } catch(e) {
        console.error('Decode error:', e);
        showDashboard();
        return;
    }

    /* Save fiche to localStorage */
    saveFiche(f);

    document.getElementById('dashboardView').style.display = 'none';
    var view = document.getElementById('ficheView');
    view.classList.add('active');

    renderFicheDetail(f);
}

function showFicheFromStorage(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;

    document.getElementById('dashboardView').style.display = 'none';
    var view = document.getElementById('ficheView');
    view.classList.add('active');

    renderFicheDetail(f);
}

function renderFicheDetail(f) {
    /* Header */
    document.getElementById('fCommande').textContent = f.commande || '';
    document.getElementById('fNom').textContent = f.nom || '';
    document.getElementById('fTel').textContent = f.telephone || '';
    document.getElementById('fDate').textContent = f.date || '';

    /* Badge paiement */
    var badge = document.getElementById('fBadge');
    var statut = (f.paiement && f.paiement.statut) || 'NON';
    if (statut === 'OUI') {
        badge.textContent = 'PAYE'; badge.className = 'badge badge-paid';
    } else if (statut === 'ACOMPTE') {
        badge.textContent = 'ACOMPTE'; badge.className = 'badge badge-acompte';
    } else {
        badge.textContent = 'A REGLER'; badge.className = 'badge badge-unpaid';
    }

    /* Mockups */
    document.getElementById('fMockupFront').src = f.mockupFront || '';
    document.getElementById('fMockupBack').src = f.mockupBack || '';

    /* Details */
    document.getElementById('fCollection').textContent = f.collection || '\u2014';
    document.getElementById('fReference').textContent = f.reference || '\u2014';
    document.getElementById('fTaille').textContent = f.taille || '\u2014';

    var couleurHtml = '';
    if (f.couleur) {
        couleurHtml = '<span class="color-dot" style="background:' + (f.couleur.hex || '#fff') + '"></span>' + (f.couleur.nom || '');
    }
    document.getElementById('fCouleur').innerHTML = couleurHtml || '\u2014';

    document.getElementById('fLogoAvant').textContent = f.logoAvant || 'Aucun';
    document.getElementById('fLogoArriere').textContent = f.logoArriere || 'Aucun';

    /* Note */
    var noteSection = document.getElementById('fNoteSection');
    if (f.note && f.note.trim()) {
        noteSection.style.display = '';
        document.getElementById('fNote').textContent = f.note;
    } else {
        noteSection.style.display = 'none';
    }

    /* Payment block */
    var payDiv = document.getElementById('fPayment');
    payDiv.className = 'fiche-payment';
    if (statut === 'OUI') {
        payDiv.classList.add('pay-oui');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'PAYE';
        document.getElementById('fPayStatut').style.color = '#32D74B';
        document.getElementById('fPayAcompte').textContent = '';
    } else if (statut === 'ACOMPTE') {
        payDiv.classList.add('pay-acompte');
        document.getElementById('fPayLabel').textContent = 'Paiement partiel';
        document.getElementById('fPayStatut').textContent = 'ACOMPTE';
        document.getElementById('fPayStatut').style.color = '#FF9F0A';
        var ac = (f.paiement && f.paiement.acompte) ? f.paiement.acompte + ' \u20AC verses' : '';
        document.getElementById('fPayAcompte').textContent = ac;
    } else {
        payDiv.classList.add('pay-non');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'A REGLER';
        document.getElementById('fPayStatut').style.color = '#FF453A';
        document.getElementById('fPayAcompte').textContent = '';
    }

    /* Prix */
    var prix = f.prix || {};
    document.getElementById('fTotal').textContent = prix.total || '0 \u20AC';
    document.getElementById('fPrixShirt').textContent = (prix.tshirt || '0') + ' \u20AC';
    document.getElementById('fPrixPerso').textContent = (prix.personnalisation || '0') + ' \u20AC';
}

/* ══════════════════════════════════════
   WHATSAPP — format phone & send
   ══════════════════════════════════════ */
function formatPhone(tel) {
    if (!tel) return '';
    var cleaned = tel.replace(/[\s\-\.\(\)]/g, '');
    /* Si commence par 0, remplacer par +33 (France) */
    if (cleaned.charAt(0) === '0') cleaned = '33' + cleaned.slice(1);
    /* Retirer le + initial s'il existe */
    if (cleaned.charAt(0) === '+') cleaned = cleaned.slice(1);
    return cleaned;
}

window.envoyerWhatsApp = function(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;

    var phone = formatPhone(f.telephone);
    var nom = f.nom || 'Client';
    var commande = f.commande || '';
    var details = (f.collection || '') + ' - ' + (f.taille || '') + ' - ' + (f.couleur && f.couleur.nom || '');

    var message = 'Bonjour ' + nom + ' !\n\n' +
        'Votre commande ' + commande + ' est terminee et prete a etre recuperee.\n\n' +
        'Details : ' + details + '\n\n' +
        'A bientot !';

    var url = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(message);
    window.open(url, '_blank');
};

window.supprimerFiche = function(key) {
    if (!confirm('Supprimer cette fiche ?')) return;
    deleteFiche(key);
    fermerOverlay();
    loadOrders();
};

/* ══════════════════════════════════════
   OVERLAY — expand / close
   ══════════════════════════════════════ */
window.fermerOverlay = function() {
    document.getElementById('expandedOverlay').classList.remove('open');
    document.body.style.overflow = '';
};

window.ouvrirFiche = function(key) {
    var fiches = getAllFiches();
    var f = fiches[key];
    if (!f) return;

    var statut = (f.paiement && f.paiement.statut) || 'NON';
    var badgeClass = statut === 'OUI' ? 'badge-paid' : (statut === 'ACOMPTE' ? 'badge-acompte' : 'badge-unpaid');
    var badgeText = statut === 'OUI' ? 'PAYE' : (statut === 'ACOMPTE' ? 'ACOMPTE' : 'A REGLER');
    var details = (f.collection || '') + ' · ' + (f.taille || '') + ' · ' + (f.couleur && f.couleur.nom || '');
    var ek = key.replace(/'/g, "\\'");

    var html =
        '<div class="expanded-card">' +
            '<div style="padding:28px 24px 20px;border-bottom:1px solid #2c2c2e;">' +
                '<div class="flex justify-between items-start">' +
                    '<div>' +
                        '<span class="text-[10px] text-zinc-500 font-black uppercase tracking-widest">' + (f.commande || '') + '</span>' +
                        '<h2 class="text-2xl font-bold mt-1 text-white">' + (f.nom || '') + '</h2>' +
                        '<p class="text-zinc-500 text-sm mt-1">' + (f.telephone || '') + '</p>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<span class="badge ' + badgeClass + '">' + badgeText + '</span>' +
                        '<p class="text-zinc-600 text-xs mt-2">' + (f.date || '') + '</p>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            (f.mockupFront ? '<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;background:#2c2c2e;">' +
                '<div style="background:#1c1c1e;padding:16px;display:flex;flex-direction:column;align-items:center;">' +
                    '<img src="' + f.mockupFront + '" style="width:100%;max-width:220px;height:auto;border-radius:12px;background:#F5F5F7;" alt="Avant">' +
                    '<span style="margin-top:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#86868b;">Avant</span>' +
                '</div>' +
                '<div style="background:#1c1c1e;padding:16px;display:flex;flex-direction:column;align-items:center;">' +
                    '<img src="' + (f.mockupBack || '') + '" style="width:100%;max-width:220px;height:auto;border-radius:12px;background:#F5F5F7;" alt="Arriere">' +
                    '<span style="margin-top:8px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:#86868b;">Arriere</span>' +
                '</div>' +
            '</div>' : '') +
            '<div style="padding:24px;">' +
                '<div class="bg-zinc-900/50 rounded-xl p-4 text-sm border border-zinc-800/50 mb-4">' +
                    '<p class="text-zinc-400"><strong class="text-zinc-200">Config :</strong> ' + details + '</p>' +
                    '<p class="text-zinc-400 mt-1"><strong class="text-zinc-200">Logo :</strong> ' + (f.logoAvant || 'Aucun') + ' / ' + (f.logoArriere || 'Aucun') + '</p>' +
                    (f.note ? '<p class="text-zinc-400 mt-2 italic"><strong class="text-zinc-200">Notes :</strong> ' + f.note + '</p>' : '') +
                '</div>' +
                '<div class="flex gap-2 mb-3">' +
                    '<button onclick="voirFiche(\'' + ek + '\')" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl py-3 font-semibold text-sm cursor-pointer transition-colors">VOIR FICHE</button>' +
                    '<button onclick="envoyerWhatsApp(\'' + ek + '\')" class="flex-1 btn-whatsapp">' +
                        '<div class="flex items-center justify-center gap-2">' +
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>' +
                            '<span>WHATSAPP</span>' +
                        '</div>' +
                    '</button>' +
                '</div>' +
                '<button onclick="supprimerFiche(\'' + ek + '\')" class="btn-delete">' +
                    '<div class="flex items-center justify-center gap-2">' +
                        '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>' +
                        '<span>SUPPRIMER</span>' +
                    '</div>' +
                '</button>' +
            '</div>' +
        '</div>';

    document.getElementById('expandedContent').innerHTML = html;
    document.getElementById('expandedOverlay').classList.add('open');
    document.body.style.overflow = 'hidden';
};

/* ══════════════════════════════════════
   DASHBOARD — mosaic grid from localStorage
   ══════════════════════════════════════ */
window.loadOrders = function() {
    var loader = document.getElementById('loader');
    loader.style.display = 'block';

    var fiches = getAllFiches();
    var grid = document.getElementById('mosaicGrid');
    var empty = document.getElementById('emptyState');

    grid.innerHTML = '';

    var keys = Object.keys(fiches);

    if (keys.length === 0) {
        empty.classList.remove('hidden'); empty.classList.add('flex');
    } else {
        empty.classList.add('hidden'); empty.classList.remove('flex');

        keys.slice().reverse().forEach(function(key) {
            var f = fiches[key];
            var statut = (f.paiement && f.paiement.statut) || 'NON';
            var badgeClass = statut === 'OUI' ? 'badge-paid' : (statut === 'ACOMPTE' ? 'badge-acompte' : 'badge-unpaid');
            var badgeText = statut === 'OUI' ? 'PAYE' : (statut === 'ACOMPTE' ? 'ACOMPTE' : 'A REGLER');

            var tile = document.createElement('div');
            tile.className = 'mosaic-tile';
            tile.onclick = function() { ouvrirFiche(key); };

            tile.innerHTML =
                (f.mockupFront
                    ? '<img class="mosaic-thumb" src="' + f.mockupFront + '" alt="Mockup">'
                    : '<div class="mosaic-thumb" style="display:flex;align-items:center;justify-content:center;color:#3a3a3c;">' +
                        '<svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>' +
                      '</div>') +
                '<div class="mosaic-info">' +
                    '<div class="flex justify-between items-start gap-2">' +
                        '<div style="min-width:0;">' +
                            '<p class="text-sm font-bold text-white truncate">' + (f.nom || 'Sans nom') + '</p>' +
                            '<p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mt-1">' + (f.commande || '') + '</p>' +
                        '</div>' +
                        '<span class="badge ' + badgeClass + '" style="flex-shrink:0;">' + badgeText + '</span>' +
                    '</div>' +
                    '<p class="text-[11px] text-zinc-600 mt-2 truncate">' + (f.collection || '') + ' · ' + (f.taille || '') + '</p>' +
                '</div>';
            grid.appendChild(tile);
        });
    }

    loader.style.display = 'none';
};

window.voirFiche = function(key) {
    fermerOverlay();
    showFicheFromStorage(key);
};

/* ── Init ── */
route();
window.addEventListener('hashchange', route);

})();
</script>
</body>
</html>
