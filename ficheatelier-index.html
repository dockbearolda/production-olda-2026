<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atelier — Production</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #000; color: #fff;
            -webkit-font-smoothing: antialiased;
        }

        /* ── Dashboard ── */
        .order-card {
            background: #1c1c1e; border-radius: 24px;
            border: 1px solid #2c2c2e;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .btn-ready {
            background: #34C759; color: #fff; border-radius: 14px;
            padding: 16px; font-weight: 700; width: 100%; transition: 0.2s; cursor: pointer; border: none; font-size: 15px;
        }
        .btn-ready:active { transform: scale(0.96); opacity: 0.8; }

        .badge { padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-paid { background: rgba(52,199,89,0.15); color: #32D74B; }
        .badge-unpaid { background: rgba(255,69,58,0.15); color: #FF453A; }
        .badge-acompte { background: rgba(255,149,0,0.15); color: #FF9F0A; }

        .loader { width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Fiche detail view ── */
        .fiche-view { display: none; min-height: 100vh; padding: 20px; }
        .fiche-view.active { display: block; }

        .fiche-card {
            background: #1c1c1e; border-radius: 28px;
            border: 1px solid #2c2c2e;
            max-width: 600px; margin: 0 auto;
            overflow: hidden;
        }

        .fiche-header {
            padding: 28px 24px 20px;
            border-bottom: 1px solid #2c2c2e;
        }

        .fiche-mockups {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px;
            background: #2c2c2e;
        }
        .fiche-mockups .mockup-side {
            background: #1c1c1e; padding: 16px;
            display: flex; flex-direction: column; align-items: center;
        }
        .fiche-mockups img {
            width: 100%; max-width: 220px; height: auto;
            border-radius: 12px; background: #F5F5F7;
        }
        .fiche-mockups .side-label {
            margin-top: 8px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px; color: #86868b;
        }

        .fiche-details { padding: 24px; }

        .detail-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 13px; color: #86868b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-value { font-size: 15px; font-weight: 600; text-align: right; }

        .fiche-total {
            margin: 0 24px; padding: 24px 0;
            border-top: 1px solid #2c2c2e;
            text-align: center;
        }

        .fiche-note {
            margin: 0 24px 24px; padding: 16px;
            background: rgba(255,255,255,0.03);
            border-radius: 14px; border: 1px solid #2c2c2e;
        }

        .fiche-payment {
            margin: 0 24px 24px; padding: 20px;
            border-radius: 16px; text-align: center;
        }
        .fiche-payment.pay-oui { background: rgba(52,199,89,0.1); border: 1px solid rgba(52,199,89,0.25); }
        .fiche-payment.pay-non { background: rgba(255,69,58,0.1); border: 1px solid rgba(255,69,58,0.25); }
        .fiche-payment.pay-acompte { background: rgba(255,149,0,0.1); border: 1px solid rgba(255,149,0,0.25); }

        .color-dot {
            display: inline-block; width: 14px; height: 14px; border-radius: 50%;
            vertical-align: middle; margin-right: 6px;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .btn-back {
            display: inline-flex; align-items: center; gap: 6px;
            background: #2c2c2e; color: #fff; border: none; border-radius: 14px;
            padding: 12px 20px; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: 0.2s; font-family: inherit;
        }
        .btn-back:active { transform: scale(0.96); opacity: 0.8; }

        @media print {
            body { background: #fff; color: #000; }
            .fiche-card { border: 2px solid #000; background: #fff; }
            .fiche-header { border-bottom: 2px solid #000; }
            .detail-label { color: #666; }
            .btn-back, #dashboardView { display: none !important; }
            .fiche-mockups { background: #eee; }
            .fiche-mockups .mockup-side { background: #fff; }
        }
    </style>
</head>
<body>

<!-- ════════════════════════════════════
     DASHBOARD VIEW (existing)
     ════════════════════════════════════ -->
<div id="dashboardView" class="p-6 md:p-10">
    <header class="flex justify-between items-center mb-12">
        <div>
            <h1 class="text-4xl font-black tracking-tight">Atelier</h1>
            <p class="text-zinc-500 font-medium">Production textile en temps reel</p>
        </div>
        <div class="flex items-center gap-4">
            <div id="loader" class="loader"></div>
            <button onclick="loadOrders()" class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded-full transition-colors cursor-pointer">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </header>

    <div id="orderGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>

    <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-zinc-600">
        <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" class="mb-4"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
        <p class="text-xl font-medium">Aucune commande en cours</p>
    </div>
</div>

<!-- ════════════════════════════════════
     FICHE VIEW (new — receives hash data)
     ════════════════════════════════════ -->
<div id="ficheView" class="fiche-view">
    <div style="max-width:600px;margin:0 auto 16px;">
        <button class="btn-back" onclick="goToDashboard()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            Dashboard
        </button>
    </div>

    <div class="fiche-card">
        <!-- Header -->
        <div class="fiche-header">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-[10px] text-zinc-500 font-black uppercase tracking-widest" id="fCommande"></p>
                    <h2 class="text-2xl font-bold mt-1" id="fNom"></h2>
                    <p class="text-zinc-500 text-sm mt-1" id="fTel"></p>
                </div>
                <div class="text-right">
                    <span class="badge" id="fBadge"></span>
                    <p class="text-zinc-600 text-xs mt-2" id="fDate"></p>
                </div>
            </div>
        </div>

        <!-- Mockups -->
        <div class="fiche-mockups">
            <div class="mockup-side">
                <img id="fMockupFront" alt="Avant">
                <span class="side-label">Avant</span>
            </div>
            <div class="mockup-side">
                <img id="fMockupBack" alt="Arriere">
                <span class="side-label">Arriere</span>
            </div>
        </div>

        <!-- Details -->
        <div class="fiche-details">
            <div class="detail-row">
                <span class="detail-label">Collection</span>
                <span class="detail-value" id="fCollection"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Reference</span>
                <span class="detail-value" id="fReference"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Taille</span>
                <span class="detail-value" id="fTaille"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Couleur</span>
                <span class="detail-value" id="fCouleur"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo avant</span>
                <span class="detail-value" id="fLogoAvant"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Logo arriere</span>
                <span class="detail-value" id="fLogoArriere"></span>
            </div>
        </div>

        <!-- Note -->
        <div class="fiche-note" id="fNoteSection">
            <p class="text-[11px] text-zinc-500 font-bold uppercase tracking-wide mb-1">Note</p>
            <p class="text-sm text-zinc-300" id="fNote"></p>
        </div>

        <!-- Payment status -->
        <div class="fiche-payment" id="fPayment">
            <p class="text-[11px] font-bold uppercase tracking-wide mb-2 opacity-60" id="fPayLabel"></p>
            <p class="text-3xl font-black tracking-tight" id="fPayStatut"></p>
            <p class="text-sm mt-1 opacity-70" id="fPayAcompte"></p>
        </div>

        <!-- Total -->
        <div class="fiche-total">
            <p class="text-zinc-500 text-xs font-semibold uppercase tracking-wide mb-1">Total</p>
            <p class="text-5xl font-black tracking-tighter" id="fTotal"></p>
            <div class="flex justify-center gap-6 mt-2 text-xs text-zinc-600">
                <span>T-Shirt: <strong class="text-zinc-400" id="fPrixShirt"></strong></span>
                <span>Perso: <strong class="text-zinc-400" id="fPrixPerso"></strong></span>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
'use strict';

/* ══════════════════════════════════════
   ROUTING — hash present → fiche / else → dashboard
   ══════════════════════════════════════ */
function route() {
    var hash = window.location.hash.slice(1);
    if (hash) {
        showFiche(hash);
    } else {
        showDashboard();
    }
}

function showDashboard() {
    document.getElementById('ficheView').classList.remove('active');
    document.getElementById('dashboardView').style.display = '';
    loadOrders();
}

window.goToDashboard = function() {
    history.pushState(null, '', window.location.pathname);
    showDashboard();
};

/* ══════════════════════════════════════
   FICHE DISPLAY
   ══════════════════════════════════════ */
function showFiche(encoded) {
    try {
        var json = decodeURIComponent(escape(atob(encoded)));
        var f = JSON.parse(json);
    } catch(e) {
        console.error('Decode error:', e);
        showDashboard();
        return;
    }

    document.getElementById('dashboardView').style.display = 'none';
    var view = document.getElementById('ficheView');
    view.classList.add('active');

    /* Header */
    document.getElementById('fCommande').textContent = f.commande || '';
    document.getElementById('fNom').textContent = f.nom || '';
    document.getElementById('fTel').textContent = f.telephone || '';
    document.getElementById('fDate').textContent = f.date || '';

    /* Badge paiement */
    var badge = document.getElementById('fBadge');
    var statut = (f.paiement && f.paiement.statut) || 'NON';
    if (statut === 'OUI') {
        badge.textContent = 'PAYE'; badge.className = 'badge badge-paid';
    } else if (statut === 'ACOMPTE') {
        badge.textContent = 'ACOMPTE'; badge.className = 'badge badge-acompte';
    } else {
        badge.textContent = 'A REGLER'; badge.className = 'badge badge-unpaid';
    }

    /* Mockups */
    document.getElementById('fMockupFront').src = f.mockupFront || '';
    document.getElementById('fMockupBack').src = f.mockupBack || '';

    /* Details */
    document.getElementById('fCollection').textContent = f.collection || '—';
    document.getElementById('fReference').textContent = f.reference || '—';
    document.getElementById('fTaille').textContent = f.taille || '—';

    var couleurHtml = '';
    if (f.couleur) {
        couleurHtml = '<span class="color-dot" style="background:' + (f.couleur.hex || '#fff') + '"></span>' + (f.couleur.nom || '');
    }
    document.getElementById('fCouleur').innerHTML = couleurHtml || '—';

    document.getElementById('fLogoAvant').textContent = f.logoAvant || 'Aucun';
    document.getElementById('fLogoArriere').textContent = f.logoArriere || 'Aucun';

    /* Note */
    var noteSection = document.getElementById('fNoteSection');
    if (f.note && f.note.trim()) {
        noteSection.style.display = '';
        document.getElementById('fNote').textContent = f.note;
    } else {
        noteSection.style.display = 'none';
    }

    /* Payment block */
    var payDiv = document.getElementById('fPayment');
    payDiv.className = 'fiche-payment';
    if (statut === 'OUI') {
        payDiv.classList.add('pay-oui');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'PAYE';
        document.getElementById('fPayStatut').style.color = '#32D74B';
        document.getElementById('fPayAcompte').textContent = '';
    } else if (statut === 'ACOMPTE') {
        payDiv.classList.add('pay-acompte');
        document.getElementById('fPayLabel').textContent = 'Paiement partiel';
        document.getElementById('fPayStatut').textContent = 'ACOMPTE';
        document.getElementById('fPayStatut').style.color = '#FF9F0A';
        var ac = (f.paiement && f.paiement.acompte) ? f.paiement.acompte + ' \u20AC verses' : '';
        document.getElementById('fPayAcompte').textContent = ac;
    } else {
        payDiv.classList.add('pay-non');
        document.getElementById('fPayLabel').textContent = 'Paiement';
        document.getElementById('fPayStatut').textContent = 'A REGLER';
        document.getElementById('fPayStatut').style.color = '#FF453A';
        document.getElementById('fPayAcompte').textContent = '';
    }

    /* Prix */
    var prix = f.prix || {};
    document.getElementById('fTotal').textContent = prix.total || '0 \u20AC';
    document.getElementById('fPrixShirt').textContent = (prix.tshirt || '0') + ' \u20AC';
    document.getElementById('fPrixPerso').textContent = (prix.personnalisation || '0') + ' \u20AC';
}

/* ══════════════════════════════════════
   DASHBOARD — existing logic
   ══════════════════════════════════════ */
const API_URL = "TON_URL_APPS_SCRIPT_ICI";

window.loadOrders = async function() {
    var loader = document.getElementById('loader');
    loader.style.display = 'block';

    try {
        var res = await fetch(API_URL);
        var data = await res.json();
        var grid = document.getElementById('orderGrid');
        var empty = document.getElementById('emptyState');

        grid.innerHTML = '';

        var activeOrders = data.filter(function(o) { return o.orderNo && o.orderNo !== ''; });

        if (activeOrders.length === 0) {
            empty.classList.remove('hidden'); empty.classList.add('flex');
        } else {
            empty.classList.add('hidden'); empty.classList.remove('flex');
        }

        activeOrders.reverse().forEach(function(order) {
            var card = document.createElement('div');
            card.className = 'order-card flex flex-col';
            card.innerHTML =
                '<div class="p-6 flex justify-between items-start">' +
                    '<div>' +
                        '<span class="text-[10px] text-zinc-500 font-black uppercase tracking-widest">' + order.orderNo + '</span>' +
                        '<h2 class="text-xl font-bold mt-1 text-white">' + order.client + '</h2>' +
                    '</div>' +
                    '<span class="badge ' + (order.paid === 'OUI' ? 'badge-paid' : 'badge-unpaid') + '">' +
                        (order.paid === 'OUI' ? 'PAYE' : 'A REGLER') +
                    '</span>' +
                '</div>' +
                '<div class="px-4">' +
                    '<div class="bg-white rounded-xl overflow-hidden shadow-inner">' +
                        '<img src="' + order.ficheUrl + '" class="w-full h-auto" alt="Fiche">' +
                    '</div>' +
                '</div>' +
                '<div class="p-6 space-y-4 mt-auto">' +
                    '<div class="bg-zinc-900/50 rounded-xl p-4 text-sm border border-zinc-800/50">' +
                        '<p class="text-zinc-400"><strong class="text-zinc-200">Config :</strong> ' + order.details + '</p>' +
                        '<p class="text-zinc-400 mt-2 italic"><strong class="text-zinc-200">Notes :</strong> ' + (order.note || 'Aucune') + '</p>' +
                    '</div>' +
                    '<button onclick="terminerCommande(\'' + order.orderNo + '\')" id="btn-' + order.orderNo + '" class="btn-ready">' +
                        '<div class="flex items-center justify-center gap-2">' +
                            '<span>TERMINE</span>' +
                            '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>' +
                        '</div>' +
                    '</button>' +
                '</div>';
            grid.appendChild(card);
        });
    } catch(err) {
        console.error('Erreur de chargement:', err);
    } finally {
        loader.style.display = 'none';
    }
};

window.terminerCommande = async function(id) {
    var btn = document.getElementById('btn-' + id);
    var originalContent = btn.innerHTML;

    if (!confirm('Confirmer la fin de production ?')) return;

    btn.disabled = true;
    btn.innerHTML = '<span class="animate-pulse">ARCHIVAGE...</span>';

    try {
        var response = await fetch(API_URL + '?action=archive&orderNo=' + id);
        var result = await response.text();

        if (result === 'Archive') {
            btn.closest('.order-card').style.opacity = '0';
            btn.closest('.order-card').style.transform = 'scale(0.9)';
            setTimeout(loadOrders, 500);
        }
    } catch(err) {
        alert('Erreur lors de l\'archivage.');
        btn.disabled = false;
        btn.innerHTML = originalContent;
    }
};

/* ── Init ── */
route();
window.addEventListener('hashchange', route);

/* Auto-refresh dashboard every 2 min */
setInterval(function() {
    if (!window.location.hash) loadOrders();
}, 120000);

})();
</script>
</body>
</html>
