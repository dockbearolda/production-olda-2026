<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['-apple-system','BlinkMacSystemFont','SF Pro Display','SF Pro Text','Helvetica Neue','Helvetica','Arial','sans-serif'] } } } }
    </script>
    <style>
        :root {
            --accent: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --bg: #F5F5F7;
            --card: #FFFFFF;
            --glass: rgba(255,255,255,0.72);
            --glass-border: rgba(255,255,255,0.45);
            --border: rgba(0,0,0,0.06);
            --separator: #D2D2D7;
            --text-1: #1D1D1F;
            --text-2: #86868B;
            --text-3: #AEAEB2;
            --radius: 12px;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text-1);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            letter-spacing: -0.022em;
        }

        /* ═══════════════════════════════════
           PROGRESS BAR
           ═══════════════════════════════════ */
        .progress-track { height: 3px; background: rgba(0,0,0,0.06); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ═══════════════════════════════════
           CARDS
           ═══════════════════════════════════ */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 0 0 0.5px rgba(0,0,0,0.03);
        }

        /* ═══════════════════════════════════
           INPUTS
           ═══════════════════════════════════ */
        .input {
            background: var(--bg);
            border: 1.5px solid transparent;
            border-radius: var(--radius);
            padding: 14px 16px;
            width: 100%;
            outline: none;
            font-size: 16px;
            color: var(--text-1);
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
            letter-spacing: -0.022em;
        }
        .input:focus { border-color: var(--accent); box-shadow: 0 0 0 3.5px rgba(0,122,255,0.12); }
        .input::placeholder { color: var(--text-3); }

        /* ═══════════════════════════════════
           CUSTOM SELECT (Apple Style)
           ═══════════════════════════════════ */
        .aselect { position: relative; user-select: none; }

        .aselect-trigger {
            background: var(--bg);
            border: 1.5px solid transparent;
            border-radius: var(--radius);
            padding: 14px 40px 14px 16px;
            font-size: 16px;
            color: var(--text-1);
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
            width: 100%;
            display: block;
            font-family: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: -0.022em;
        }
        .aselect-trigger.placeholder { color: var(--text-3); }
        .aselect.open .aselect-trigger { border-color: var(--accent); box-shadow: 0 0 0 3.5px rgba(0,122,255,0.12); }

        .aselect-chevron {
            position: absolute; right: 14px; top: 50%;
            transform: translateY(-50%); pointer-events: none;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-3);
        }
        .aselect.open .aselect-chevron { transform: translateY(-50%) rotate(180deg); }

        .aselect-dropdown {
            position: absolute; top: calc(100% + 6px); left: 0; right: 0;
            background: rgba(255,255,255,0.88);
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04), 0 0 0 0.5px rgba(0,0,0,0.03);
            z-index: 200;
            overflow: hidden;
            transform-origin: top center;
            animation: aselOpen 0.2s cubic-bezier(0.2, 0, 0, 1.1);
            max-height: 280px; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .aselect-dropdown::-webkit-scrollbar { display: none; }

        @keyframes aselOpen {
            from { opacity: 0; transform: scaleY(0.92) translateY(-6px); }
            to { opacity: 1; transform: scaleY(1) translateY(0); }
        }

        .aselect-opt {
            padding: 13px 16px; font-size: 16px; cursor: pointer;
            transition: background 0.1s;
            display: flex; align-items: center; justify-content: space-between;
            font-family: inherit;
        }
        .aselect-opt:active { background: rgba(0,122,255,0.08); }
        .aselect-opt:hover { background: var(--bg); }
        .aselect-opt + .aselect-opt { border-top: 0.5px solid var(--border); }
        .aselect-opt.on { color: var(--accent); font-weight: 600; }
        .aselect-opt.on::after {
            content: '';
            width: 18px; height: 18px; flex-shrink: 0;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23007AFF' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6L9 17l-5-5'/%3E%3C/svg%3E") center/contain no-repeat;
        }

        /* Compact selects for 3-col grid */
        .aselect-compact .aselect-trigger { padding: 12px 28px 12px 12px; font-size: 14px; }
        .aselect-compact .aselect-chevron { right: 10px; }

        /* ═══════════════════════════════════
           BUTTONS
           ═══════════════════════════════════ */
        .btn {
            border: none; border-radius: var(--radius); padding: 16px 24px;
            font-weight: 600; font-size: 17px; text-align: center; width: 100%;
            cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px;
            letter-spacing: -0.022em;
        }
        .btn:active { transform: scale(0.97); opacity: 0.85; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #0066D6; }
        .btn-dark { background: var(--text-1); color: white; }
        .btn-dark:hover { background: #333; }
        .btn-ghost { background: white; color: var(--text-2); box-shadow: 0 0 0 0.5px var(--separator); }
        .btn-ghost:hover { background: var(--bg); }

        /* Payment option cards — neutral by default, colored only when selected */
        .pay-opt {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 14px 16px; border-radius: var(--radius);
            background: var(--bg); border: 1.5px solid var(--border);
            color: var(--text-2); font-size: 15px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; font-family: inherit; text-align: left;
        }
        .pay-opt:active { transform: scale(0.98); opacity: 0.9; }
        .pay-opt.on {
            background: var(--pay-bg-on); border-color: var(--pay-border-on); color: var(--pay-color);
        }
        .pay-opt::after {
            content: ''; width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0;
            border: 2px solid var(--separator); transition: all 0.2s;
        }
        .pay-opt.on::after {
            border-color: var(--pay-color); background: var(--pay-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6L9 17l-5-5'/%3E%3C/svg%3E");
            background-size: 12px; background-repeat: no-repeat; background-position: center;
        }

        /* ═══════════════════════════════════
           STEPS
           ═══════════════════════════════════ */
        .step { display: none; flex-direction: column; gap: 16px; }
        .step.active { display: flex; animation: enterStep 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes enterStep {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ═══════════════════════════════════
           LABELS
           ═══════════════════════════════════ */
        .label { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-3); }
        .section-title { font-size: 13px; font-weight: 600; color: var(--text-2); letter-spacing: -0.01em; }

        /* ═══════════════════════════════════
           SEGMENTED CONTROL
           ═══════════════════════════════════ */
        .seg { display: flex; background: rgba(0,0,0,0.06); border-radius: 10px; padding: 2px; }
        .seg-btn {
            flex: 1; padding: 8px 4px; font-size: 13px; font-weight: 600; text-align: center;
            border-radius: 8px; color: var(--text-2); cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none; border: none; background: none; font-family: inherit;
        }
        .seg-btn.on { color: var(--text-1); background: white; box-shadow: 0 1px 4px rgba(0,0,0,0.08), 0 0.5px 1px rgba(0,0,0,0.04); }

        /* ═══════════════════════════════════
           STAGE (T-Shirt Preview)
           ═══════════════════════════════════ */
        .stage {
            background: linear-gradient(180deg, #F5F5F7 0%, #EEEEF0 100%);
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
        }
        .stage::after {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(ellipse at 50% 90%, rgba(0,0,0,0.04) 0%, transparent 55%);
            pointer-events: none; border-radius: var(--radius);
        }

        /* ── Grille double t-shirt ── */
        .shirts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            align-items: start;
        }
        .shirt-col { display: flex; flex-direction: column; align-items: stretch; }
        .shirt-side-label {
            font-size: 10px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 1.5px; color: #86868b; text-align: center;
            margin-bottom: 5px; transition: color 0.15s;
        }
        .shirt-col.active .shirt-side-label { color: var(--accent); }

        /* svg-view : fluide, ratio t-shirt */
        .svg-view {
            position: relative;
            width: 100%;
            aspect-ratio: 5 / 6;
            overflow: hidden;
        }
        .svg-box {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .svg-box svg {
            height: 100%; width: auto; max-width: 100%;
            filter: drop-shadow(0 4px 18px rgba(0,0,0,0.09));
        }


        /* ═══════════════════════════════════
           LOGO ZONE (Keynote Interaction)
           ═══════════════════════════════════ */
        .logo-zone {
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
            z-index: 10;
            touch-action: none;
        }
        .logo-zone.empty { pointer-events: none; }
        .logo-zone.has-logo { cursor: move; }

        .logo-inner {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }
        .logo-inner img, .logo-inner svg {
            max-width: 100%; max-height: 100%; object-fit: contain;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.1));
            opacity: 0.92; mix-blend-mode: multiply;
        }

        /* Selection Frame (Keynote style) */
        .logo-frame {
            position: absolute; inset: -6px;
            border: 1.5px solid var(--accent);
            border-radius: 3px;
            pointer-events: none;
            display: none;
        }
        .logo-zone.selected .logo-frame { display: block; }

        /* Indicateurs de coin (resize visuel quand sélectionné) */
        .logo-zone.selected::before,
        .logo-zone.selected::after {
            content: '';
            position: absolute;
            width: 10px; height: 10px;
            border-color: var(--accent);
            border-style: solid;
            z-index: 12;
            pointer-events: none;
        }
        .logo-zone.selected::before {
            top: -1px; left: -1px;
            border-width: 2.5px 0 0 2.5px;
            border-radius: 2px 0 0 0;
        }
        .logo-zone.selected::after {
            bottom: -1px; right: -1px;
            border-width: 0 2.5px 2.5px 0;
            border-radius: 0 0 2px 0;
        }

        /* ═══════════════════════════════════
           TAP OVERLAY (état vide du t-shirt)
           ═══════════════════════════════════ */
        .logo-tap-overlay {
            position: absolute;
            inset: 0;
            z-index: 5;
            cursor: pointer;
        }
        .logo-tap-pip {
            position: absolute;
            width: 34px; height: 34px;
            border-radius: 50%;
            background: rgba(0,122,255,0.11);
            border: 1.5px solid rgba(0,122,255,0.28);
            display: flex; align-items: center; justify-content: center;
            transform: translate(-50%, -50%);
            transition: background 0.15s, transform 0.15s;
            animation: tapPulse 2.4s ease-out infinite;
        }
        /* Position cœur pour l'avant (poitrine gauche du porteur = droite de l'image) */
        .logo-tap-front .logo-tap-pip { left: 60.5%; top: 33%; }
        /* Arrière décalé 2.5% à gauche */
        .logo-tap-back  .logo-tap-pip { left: 47.5%; top: 33%; }

        .logo-tap-overlay:active .logo-tap-pip {
            background: rgba(0,122,255,0.22);
            transform: translate(-50%, -50%) scale(0.88);
            animation: none;
        }
        .logo-tap-overlay.gone { display: none; }

        @keyframes tapPulse {
            0%   { box-shadow: 0 0 0 0 rgba(0,122,255,0.22); }
            60%  { box-shadow: 0 0 0 9px rgba(0,122,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(0,122,255,0); }
        }

        /* ═══════════════════════════════════
           FLOAT BAR (barre flottante logo)
           ═══════════════════════════════════ */
        .logo-float-bar {
            margin: 8px 2px 0;
            padding: 8px 12px;
            background: rgba(255,255,255,0.94);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 14px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.09), 0 0 0 0.5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            animation: enterStep 0.2s ease;
        }
        .fbar-btn {
            padding: 5px 11px;
            border-radius: 9px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            letter-spacing: -0.01em;
            flex-shrink: 0;
        }
        .fbar-btn:active { transform: scale(0.93); }
        .fbar-change { background: rgba(0,122,255,0.1); color: var(--accent); }
        .fbar-remove { background: rgba(255,59,48,0.08); color: var(--red); }

        /* ═══════════════════════════════════
           LOGO BOTTOM SHEET
           ═══════════════════════════════════ */
        .lsheet-backdrop {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.32);
            z-index: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .lsheet-backdrop.open { opacity: 1; pointer-events: auto; }
        .lsheet {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #F5F5F7;
            border-radius: 22px 22px 0 0;
            z-index: 600;
            transform: translateY(100%);
            transition: transform 0.44s cubic-bezier(0.32, 0.72, 0, 1);
            max-height: 78vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -1px 0 rgba(0,0,0,0.05), 0 -8px 40px rgba(0,0,0,0.12);
        }
        .lsheet.open { transform: translateY(0); }
        .lsheet-handle-row { padding: 10px; display: flex; justify-content: center; flex-shrink: 0; }
        .lsheet-handle { width: 36px; height: 4px; background: rgba(0,0,0,0.15); border-radius: 2px; }
        .lsheet-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px 14px; flex-shrink: 0;
        }
        .lsheet-title { font-size: 18px; font-weight: 700; color: var(--text-1); letter-spacing: -0.025em; }
        .lsheet-close-btn {
            width: 30px; height: 30px; border-radius: 50%;
            background: rgba(0,0,0,0.07); border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-2); font-weight: 700; font-size: 14px; font-family: inherit;
            transition: background 0.15s;
        }
        .lsheet-close-btn:active { background: rgba(0,0,0,0.14); }
        .lsheet-scroll {
            overflow-y: auto; flex: 1; padding: 4px 16px 36px;
            -webkit-overflow-scrolling: touch;
        }
        .lsheet-scroll::-webkit-scrollbar { display: none; }
        .lsheet-group-label {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.09em; color: var(--text-3); margin: 14px 0 8px 4px;
        }
        .lsheet-logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .lsheet-thumb {
            border-radius: 14px; background: white;
            border: 1.5px solid transparent;
            cursor: pointer; padding: 10px 8px 8px;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: all 0.18s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04), 0 0 0 0.5px rgba(0,0,0,0.04);
        }
        .lsheet-thumb:active { transform: scale(0.95); }
        .lsheet-thumb.on { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
        .lsheet-thumb svg { width: 56px; height: 56px; }
        .lsheet-thumb-name { font-size: 10px; font-weight: 600; color: var(--text-2); letter-spacing: 0.02em; }
        .lsheet-sep { height: 0.5px; background: var(--separator); margin: 16px 0 4px; }
        .lsheet-upload-row {
            display: flex; align-items: center; gap: 12px;
            padding: 13px 14px; border-radius: 14px;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04), 0 0 0 0.5px rgba(0,0,0,0.04);
            cursor: pointer; border: none; width: 100%;
            font-family: inherit; text-align: left;
        }
        .lsheet-upload-icon {
            width: 38px; height: 38px; border-radius: 10px;
            background: rgba(0,122,255,0.1);
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .lsheet-color-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px; }
        .lsheet-color-dot {
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.12);
            position: relative; transition: transform 0.18s; flex-shrink: 0;
            border: none;
        }
        .lsheet-color-dot::before {
            content: ''; position: absolute; inset: -4px;
            border-radius: 50%; border: 2px solid transparent; transition: border-color 0.18s;
        }
        .lsheet-color-dot.on::before { border-color: var(--accent); }
        .lsheet-color-dot.on { transform: scale(0.82); }
        .lsheet-color-section { display: none; }
        .lsheet-color-section.visible { display: block; }

        /* ═══════════════════════════════════
           COLOR SWATCHES (iPhone Style)
           ═══════════════════════════════════ */
        .swatch-row { display: flex; flex-wrap: wrap; gap: 12px; }

        .swatch {
            width: 34px; height: 34px; border-radius: 50%;
            cursor: pointer; border: none; position: relative;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0; background: none; outline: none;
        }
        .swatch-fill {
            width: 100%; height: 100%; border-radius: 50%;
            box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .swatch:hover .swatch-fill { transform: scale(1.1); }
        .swatch:active .swatch-fill { transform: scale(0.92); }

        /* iPhone ring: outer ring with gap */
        .swatch::before {
            content: ''; position: absolute;
            inset: -4px; border-radius: 50%;
            border: 2px solid transparent;
            transition: border-color 0.25s ease;
        }
        .swatch.on::before { border-color: var(--accent); }
        .swatch.on .swatch-fill { transform: scale(0.82); }

        /* ═══════════════════════════════════
           LOGO COLOR PASTILLES
           ═══════════════════════════════════ */
        .pastille-row { display: flex; gap: 10px; flex-wrap: wrap; }

        .pastille {
            width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; border: none; position: relative;
            transition: transform 0.2s; padding: 0; background: none; outline: none;
        }
        .pastille-fill {
            width: 100%; height: 100%; border-radius: 50%;
            box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.12);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pastille::before {
            content: ''; position: absolute; inset: -3px;
            border-radius: 50%; border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .pastille.on::before { border-color: var(--accent); }
        .pastille.on .pastille-fill { transform: scale(0.78); }

        /* ═══════════════════════════════════
           LOGO THUMBS
           ═══════════════════════════════════ */
        .lthumb {
            border-radius: var(--radius); padding: 14px; cursor: pointer;
            border: 2px solid transparent;
            background: rgba(0,0,0,0.02);
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none; min-height: 90px; justify-content: center;
        }
        .lthumb:hover { background: rgba(0,0,0,0.04); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
        .lthumb:active { transform: scale(0.96); }
        .lthumb.on { border-color: var(--accent); background: rgba(0,122,255,0.04); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .lthumb svg { width: 44px; height: 44px; }

        /* ═══════════════════════════════════
           UPLOAD
           ═══════════════════════════════════ */
        .upload-area {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            padding: 16px; border-radius: var(--radius);
            border: 1.5px dashed rgba(0,122,255,0.25);
            background: rgba(0,122,255,0.02); color: var(--accent);
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: all 0.25s; width: 100%;
        }
        .upload-area:hover { background: rgba(0,122,255,0.06); border-color: var(--accent); }
        .upload-area:active { transform: scale(0.98); }
        .upload-area .plus {
            width: 26px; height: 26px; border-radius: 50%;
            background: var(--accent); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; line-height: 1;
        }

        .upload-pill {
            display: none; align-items: center; gap: 12px; padding: 10px 14px;
            border-radius: var(--radius); background: rgba(0,122,255,0.04);
            border: 1.5px solid rgba(0,122,255,0.12);
            animation: enterStep 0.3s ease;
        }
        .upload-pill.show { display: flex; }
        .upload-pill img { width: 44px; height: 44px; object-fit: contain; border-radius: 10px; background: white; padding: 3px; }
        .upload-pill .x {
            margin-left: auto; width: 26px; height: 26px; border-radius: 50%; flex-shrink: 0;
            background: rgba(255,59,48,0.06); color: var(--red);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: 700; font-size: 15px; border: none; transition: background 0.2s;
        }
        .upload-pill .x:hover { background: rgba(255,59,48,0.14); }

        /* ═══════════════════════════════════
           PREMIUM STEP 1 CARD
           ═══════════════════════════════════ */
        .s1-card {
            background: #fff;
            border-radius: 32px;
            padding: 40px 32px 36px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.03), 0 0 0 0.5px rgba(0,0,0,0.02);
        }
        .s1-meta {
            font-size: 11px;
            font-weight: 600;
            color: #AEAEB2;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        .s1-title {
            font-size: 44px;
            font-weight: 800;
            color: #1d1d1f;
            letter-spacing: -0.035em;
            line-height: 1.06;
            margin-top: 6px;
        }
        .s1-progress {
            height: 2px;
            background: #E8E8ED;
            border-radius: 1px;
            margin: 28px 0 40px;
            overflow: hidden;
        }
        .s1-progress-fill {
            height: 100%;
            background: #2563EB;
            border-radius: 1px;
            width: 33.33%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .s1-order-line {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .s1-order-val {
            font-family: 'SF Mono', ui-monospace, 'Menlo', monospace;
            font-size: 14px;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.01em;
        }
        .s1-order-dot {
            font-size: 8px;
            color: #D1D1D6;
            line-height: 1;
        }
        .s1-order-date {
            font-size: 14px;
            font-weight: 500;
            color: #86868b;
        }
        .s1-field {
            display: flex;
            align-items: center;
            padding: 18px 0;
        }
        .s1-field + .s1-field {
            border-top: 0.5px solid rgba(0,0,0,0.04);
        }
        .s1-label {
            width: 80px;
            flex-shrink: 0;
            font-size: 13px;
            font-weight: 600;
            color: #AEAEB2;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .s1-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 17px;
            font-weight: 500;
            color: #1d1d1f;
            font-family: inherit;
            letter-spacing: -0.022em;
            padding: 0 0 4px 0;
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        .s1-input::placeholder {
            color: #D1D1D6;
            font-weight: 400;
        }
        .s1-input:focus {
            border-bottom-color: #2563EB;
        }
        .s1-input.has-underline {
            border-bottom-color: #2563EB;
        }
        .s1-static {
            font-size: 17px;
            font-weight: 500;
            color: #1d1d1f;
        }
        .s1-btn {
            width: 100%;
            background: #2563EB;
            color: white;
            font-size: 17px;
            font-weight: 600;
            padding: 18px;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            margin-top: 40px;
            font-family: inherit;
            letter-spacing: -0.01em;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .s1-btn:hover { background: #1D4ED8; }
        .s1-btn:active { transform: scale(0.95); }

        /* ═══════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════ */
        @media (min-width: 768px) {
            /* svg-view sizing now via aspect-ratio, no override needed */
        }

        ::-webkit-scrollbar { width: 0; }

        /* ── Apple Success Overlay ── */
        @keyframes sfOverlayIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        @keyframes sfCardIn {
            from { opacity: 0; transform: scale(.86) translateY(32px); }
            to   { opacity: 1; transform: scale(1)  translateY(0); }
        }
        @keyframes sfCheckDraw {
            to { stroke-dashoffset: 0; }
        }
        @keyframes sfCheckBg {
            0%   { transform: scale(.6); opacity: 0; }
            60%  { transform: scale(1.12); opacity: 1; }
            100% { transform: scale(1); }
        }
        #successOverlay { display:none; }
        #successOverlay.sf-on {
            display: flex;
            position: fixed; inset: 0; z-index: 9999;
            align-items: center; justify-content: center;
            background: rgba(0,0,0,.52);
            backdrop-filter: blur(28px); -webkit-backdrop-filter: blur(28px);
            animation: sfOverlayIn .22s ease;
        }
        #successCard {
            background: #fff; border-radius: 28px;
            padding: 48px 36px 36px; width: min(370px, 92vw);
            text-align: center;
            box-shadow: 0 48px 120px rgba(0,0,0,.38);
            animation: sfCardIn .42s cubic-bezier(.34,1.44,.64,1);
        }
        .sf-check-circle {
            width: 80px; height: 80px; border-radius: 50%;
            background: #34C759; margin: 0 auto 24px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 28px rgba(52,199,89,.38);
            animation: sfCheckBg .42s cubic-bezier(.34,1.44,.64,1);
        }
        .sf-check-path {
            stroke-dasharray: 52; stroke-dashoffset: 52;
            animation: sfCheckDraw .5s .25s cubic-bezier(.4,0,.2,1) forwards;
        }
        .sf-btn-primary {
            width: 100%; background: #007AFF; color: #fff;
            border: none; border-radius: 14px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            margin-bottom: 10px; font-family: inherit;
            transition: opacity .15s;
        }
        .sf-btn-primary:active { opacity: .8; }
        .sf-btn-secondary {
            width: 100%; background: #F2F2F7; color: #1A1A1A;
            border: none; border-radius: 14px; padding: 16px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            font-family: inherit; transition: opacity .15s;
        }
        .sf-btn-secondary:active { opacity: .6; }
    </style>
</head>
<body>

<div class="max-w-lg mx-auto px-5 pt-6 pb-16">

    <!-- ════════════════════════════════════════
         HEADER
         ════════════════════════════════════════ -->
    <header class="mb-4">
        <p class="text-[11px] font-semibold text-gray-400 uppercase tracking-[0.2em]" id="hLabel">Etape 1 sur 3</p>
        <h1 class="text-[34px] font-black tracking-tight text-gray-900 leading-tight mt-1" id="hTitle">Client</h1>
        <span id="hNum" class="hidden">1</span>
        <div class="mt-5 h-[2px] bg-gray-200 rounded-full overflow-hidden">
            <div class="h-full bg-blue-600 rounded-full transition-all duration-500" id="hBar" style="width:33.33%"></div>
        </div>
    </header>

    <!-- ════════════════════════════════════════
         STEP 1 — CLIENT  (A: Commande, B: Date, C: Nom, D: Telephone)
         Single-line iCloud/Apple Business style
         ════════════════════════════════════════ -->
    <div id="s1" class="step active mt-8">
        <div class="bg-white rounded-[32px] px-7 pt-7 pb-7" style="box-shadow:0 2px 16px rgba(0,0,0,0.04);">
            <div class="divide-y divide-gray-100">

                <!-- ID — une ligne, mono -->
                <div class="flex items-center py-3">
                    <span class="w-20 shrink-0 text-[12px] font-black text-gray-300 uppercase tracking-[0.18em]">ID</span>
                    <span class="text-[13px] font-mono font-medium text-gray-400 tracking-tight select-all truncate" id="orderNo">—</span>
                </div>

                <!-- DATE — une ligne -->
                <div class="flex items-center py-3">
                    <span class="w-20 shrink-0 text-[12px] font-black text-gray-300 uppercase tracking-[0.18em]">DATE</span>
                    <span class="text-[17px] font-semibold text-gray-900" id="orderDate">15/02/2026</span>
                </div>

                <!-- NOM — une ligne -->
                <div class="flex items-center py-3">
                    <span class="w-20 shrink-0 text-[12px] font-black text-gray-300 uppercase tracking-[0.18em]">NOM</span>
                    <input type="text" id="clientNom"
                           class="flex-1 bg-transparent text-[17px] font-semibold text-gray-900 tracking-tight placeholder:text-gray-300 placeholder:font-normal outline-none border-0 focus:ring-0"
                           placeholder="Dubois" autocomplete="family-name">
                </div>

                <!-- PRÉNOM — une ligne -->
                <div class="flex items-center py-3">
                    <span class="w-20 shrink-0 text-[12px] font-black text-gray-300 uppercase tracking-[0.18em]">PRÉNOM</span>
                    <input type="text" id="clientPrenom"
                           class="flex-1 bg-transparent text-[17px] font-semibold text-gray-900 tracking-tight placeholder:text-gray-300 placeholder:font-normal outline-none border-0 focus:ring-0"
                           placeholder="Pierre" autocomplete="given-name">
                </div>

                <!-- TEL — une ligne -->
                <div class="flex items-center py-3">
                    <span class="w-20 shrink-0 text-[12px] font-black text-gray-300 uppercase tracking-[0.18em]">TEL</span>
                    <input type="tel" id="clientPhone"
                           class="flex-1 bg-transparent text-[17px] font-semibold text-gray-900 tracking-tight placeholder:text-gray-300 placeholder:font-normal outline-none border-0 focus:ring-0"
                           placeholder="0690 00 00 00">
                </div>

            </div>
        </div>

        <!-- Bouton Continuer -->
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold text-[17px] py-4 rounded-[22px] mt-5 active:scale-95 transition-all cursor-pointer" onclick="go(2)">
            Continuer
        </button>
    </div>

    <!-- ════════════════════════════════════════
         STEP 2 — CONFIGURATEUR
         (E: Collection, F: Reference, G: Taille, H: Couleur T-shirt,
          I: Motif Logo Av, J: Motif Logo Ar, K: Logo Arriere, L: Note)
         ════════════════════════════════════════ -->
    <div id="s2" class="step mt-6">

        <!-- Stage — grille double t-shirt -->
        <div class="stage p-4">

            <!-- Grille invisible : 2 colonnes parfaitement alignées -->
            <div class="shirts-grid" id="shirtsGrid">

                <!-- ── Avant ── -->
                <div class="shirt-col active" id="colFront" onclick="flipSide('front')">
                    <p class="shirt-side-label">Avant</p>
                    <div class="svg-view" id="svgViewFront">
                        <div class="svg-box" id="svgBoxFront"></div>
                        <div class="logo-tap-overlay logo-tap-front" id="logoTapFront">
                            <div class="logo-tap-pip">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                            </div>
                        </div>
                        <div class="logo-zone empty" id="logoZoneFront" data-side="front"
                             style="left:60.5%;top:33%;width:24%;height:17%;">
                            <div class="logo-inner" id="logoInnerFront"></div>
                            <div class="logo-frame"></div>
                        </div>
                    </div>
                </div>

                <!-- ── Arrière ── -->
                <div class="shirt-col" id="colBack" onclick="flipSide('back')">
                    <p class="shirt-side-label">Arrière</p>
                    <div class="svg-view" id="svgViewBack">
                        <div class="svg-box" id="svgBoxBack"></div>
                        <div class="logo-tap-overlay logo-tap-back" id="logoTapBack">
                            <div class="logo-tap-pip">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg>
                            </div>
                        </div>
                        <div class="logo-zone empty" id="logoZoneBack" data-side="back"
                             style="left:47.5%;top:33%;width:24%;height:17%;">
                            <div class="logo-inner" id="logoInnerBack"></div>
                            <div class="logo-frame"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Float bar logo (affiché quand un logo est placé sur le côté actif) -->
            <div class="logo-float-bar" id="logoFloatBar" style="display:none;">
                <button class="fbar-btn fbar-change" onclick="openLogoSheet()">Changer</button>
                <button class="fbar-btn fbar-remove" onclick="dropLogo()">Retirer</button>
            </div>


            <p class="text-center mt-3 text-[13px] font-semibold" style="color:var(--text-2)" id="colorName">Blanc</p>
        </div>

        <!-- Collection -->
        <div class="card p-5">
            <label class="label ml-1 mb-2 block">Collection</label>
            <div class="aselect" id="selCollection"></div>
        </div>

        <!-- Reference (dropdown: H-001, F-001...) -->
        <div class="card p-5">
            <label class="label ml-1 mb-2 block">Reference</label>
            <div class="aselect" id="selRef"></div>
        </div>

        <!-- Taille -->
        <div class="card p-5">
            <label class="label ml-1 mb-2 block">Taille</label>
            <div class="aselect" id="selSize"></div>
        </div>

        <!-- Couleur du t-shirt -->
        <div class="card p-5">
            <label class="label ml-1 mb-2 block">Couleur du t-shirt</label>
            <div class="aselect" id="selColor"></div>
        </div>

        <!-- Note -->
        <div class="card p-5">
            <p class="label mb-3">Note</p>
            <textarea id="note" class="input" rows="2" placeholder="Commentaires specifiques..."></textarea>
        </div>

        <div class="flex gap-3">
            <button class="btn btn-ghost" onclick="go(1)" style="flex:0 0 auto;width:auto;padding:16px 20px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button class="btn btn-primary" onclick="go(3)" style="flex:1;">Paiement</button>
        </div>
    </div>

    <!-- ════════════════════════════════════════
         STEP 3 — PAIEMENT
         (M: Prix T-shirt, N: Personnalisation, O: Total, P: Paye, Q: Fiche)
         ════════════════════════════════════════ -->
    <div id="s3" class="step mt-6">
        <div class="card p-6 space-y-5">
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <p class="label mb-2">T-Shirt</p>
                    <input type="number" id="price" class="input text-center font-bold text-lg" value="25" oninput="calcTotal()">
                </div>
                <div class="text-center">
                    <p class="label mb-2">Personnalisation</p>
                    <input type="number" id="customPrice" class="input text-center font-bold text-lg" value="0" oninput="calcTotal()">
                </div>
            </div>
            <div class="py-5 border-y text-center" style="border-color:var(--separator)">
                <p class="text-[56px] font-black tracking-tighter leading-none" id="totalLabel">25 &euro;</p>
            </div>
            <div>
                <p class="label mb-3 text-center">Statut du paiement</p>
                <div class="space-y-2" id="payStatus">
                    <button class="pay-opt on" data-p="non" onclick="setPay('non')"
                        style="--pay-color:#FF3B30;--pay-bg:rgba(255,59,48,0.04);--pay-border:rgba(255,59,48,0.12);--pay-bg-on:rgba(255,59,48,0.08);--pay-border-on:rgba(255,59,48,0.35);">
                        A regler
                    </button>
                    <button class="pay-opt" data-p="oui" onclick="setPay('oui')"
                        style="--pay-color:#34C759;--pay-bg:rgba(52,199,89,0.04);--pay-border:rgba(52,199,89,0.12);--pay-bg-on:rgba(52,199,89,0.08);--pay-border-on:rgba(52,199,89,0.35);">
                        Paye
                    </button>
                </div>
            </div>
        </div>
        <div class="flex gap-3">
            <button class="btn btn-ghost" onclick="go(2)" style="flex:0 0 auto;width:auto;padding:16px 20px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button class="btn btn-dark" id="subBtn" onclick="submit()" style="flex:1;">Valider la Commande</button>
        </div>
    </div>

</div>

<!-- ═══════════════════════════════════════════
     APPLE SUCCESS OVERLAY
════════════════════════════════════════════ -->
<div id="successOverlay">
    <div id="successCard">
        <div class="sf-check-circle">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                <path class="sf-check-path"
                      d="M10 21L17 28L30 13"
                      stroke="white" stroke-width="3.4"
                      stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <p style="font-size:24px;font-weight:700;color:#1A1A1A;margin:0 0 6px;letter-spacing:-.4px;">Commande envoyée</p>
        <p id="sfOrderNo" style="font-size:13px;color:#8E8E93;margin:0 0 10px;letter-spacing:.3px;font-variant-numeric:tabular-nums;"></p>
        <p id="sfClientName" style="font-size:15px;color:#3A3A3C;margin:0 0 30px;font-weight:500;"></p>
        <button id="sfFicheBtn" class="sf-btn-primary">Voir la fiche atelier &rsaquo;</button>
        <button class="sf-btn-secondary" onclick="location.reload()">Nouvelle commande</button>
    </div>
</div>

<!-- ═══════════════════════════════════════════
     LOGO BOTTOM SHEET (sélecteur Apple-style)
════════════════════════════════════════════ -->
<div class="lsheet-backdrop" id="lsheetBackdrop" onclick="closeLogoSheet()"></div>
<div class="lsheet" id="lsheet">
    <div class="lsheet-handle-row"><div class="lsheet-handle"></div></div>
    <div class="lsheet-header">
        <span class="lsheet-title" id="lsheetTitle">Logo Avant</span>
        <button class="lsheet-close-btn" onclick="closeLogoSheet()">✕</button>
    </div>
    <div class="lsheet-scroll">
        <!-- Couleur du logo (visible quand un logo Atelier est sélectionné) -->
        <div class="lsheet-color-section" id="lsheetColorSection">
            <div class="lsheet-group-label">Couleur du logo</div>
            <div class="lsheet-color-row" id="lsheetColorRow"></div>
            <div class="lsheet-sep"></div>
        </div>
        <!-- Grille des logos Atelier -->
        <div id="lsheetLogoGrid"></div>
        <!-- Upload mon logo -->
        <div class="lsheet-sep"></div>
        <label class="lsheet-upload-row" for="fileIn">
            <div class="lsheet-upload-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </div>
            <div>
                <p style="font-size:15px;font-weight:600;color:var(--text-1);letter-spacing:-0.02em;margin:0 0 2px;">Mon logo</p>
                <p style="font-size:12px;color:var(--text-3);margin:0;">PNG, JPEG, SVG</p>
            </div>
        </label>
        <div class="upload-pill mt-3" id="upPill">
            <img id="upThumb" src="" alt="">
            <div style="min-width:0">
                <p class="text-[13px] font-semibold truncate" id="upName">logo.png</p>
                <p class="text-[11px]" style="color:var(--text-3)">Personnalisé</p>
            </div>
            <button class="x" onclick="rmUpload()">×</button>
        </div>
    </div>
</div>
<input type="file" accept="image/png,image/jpeg,image/svg+xml,image/webp" class="hidden" id="fileIn" onchange="onUpload(event)">

<canvas id="exportCanvas" width="800" height="1100" class="hidden"></canvas>

<script>
(function(){
'use strict';

/* ══════════════════════════════════════
   CONFIG
   ══════════════════════════════════════ */
const API = "https://script.google.com/macros/s/AKfycbyzeU0tD22L8wZ94PW0f4s1a2LH7fNPhK74RtjcIXs0pWAP59anDV8EYtYlP8WX5iCk/exec";

const COLORS = [
    {n:'Blanc',h:'#FFFFFF'},{n:'Ivoire',h:'#FAF3E8'},{n:'Gris',h:'#C7C7CC'},{n:'Anthracite',h:'#4A4A4A'},
    {n:'Noir',h:'#1A1A1A'},{n:'Marine',h:'#00205B'},{n:'Bleu',h:'#007AFF'},{n:'Ciel',h:'#64D2FF'},
    {n:'Rouge',h:'#FF3B30'},{n:'Bordeaux',h:'#8B1A2B'},{n:'Vert',h:'#34C759'},{n:'Sauge',h:'#8DA67E'},
    {n:'Jaune',h:'#FFCC00'},{n:'Orange',h:'#FF9500'},{n:'Rose',h:'#FF6482'},{n:'Lavande',h:'#BDB5D5'}
];

const LOGO_COLORS = [
    {n:'Noir',h:'#1A1A1A'},{n:'Blanc',h:'#FFFFFF'},{n:'Marine',h:'#00205B'},
    {n:'Rouge',h:'#FF3B30'},{n:'Or',h:'#C5A44E'},{n:'Argent',h:'#A8A8A8'}
];

const FABRIC_RE = /rgb\(100%,\s*100%,\s*100%\)/gi;

const LOGOS = {
    bea:[
        {id:'bea-1',n:'Classic',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="60" r="50" stroke="#1A1A1A" stroke-width="3" fill="none"/><text x="60" y="52" text-anchor="middle" font-size="28" font-weight="800" fill="#1A1A1A" font-family="sans-serif">BEA</text><text x="60" y="74" text-anchor="middle" font-size="12" font-weight="600" fill="#1A1A1A" letter-spacing="4" font-family="sans-serif">ATELIER</text><line x1="28" y1="82" x2="92" y2="82" stroke="#1A1A1A" stroke-width="1.5"/><text x="60" y="98" text-anchor="middle" font-size="10" fill="#1A1A1A" font-family="sans-serif">— 16 —</text></svg>`},
        {id:'bea-2',n:'Minimal',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><rect x="15" y="25" width="90" height="70" rx="4" stroke="#1A1A1A" stroke-width="2.5" fill="none"/><text x="60" y="60" text-anchor="middle" font-size="32" font-weight="900" fill="#1A1A1A" font-family="sans-serif">B</text><text x="60" y="82" text-anchor="middle" font-size="9" font-weight="600" fill="#1A1A1A" letter-spacing="6" font-family="sans-serif">BEAUTE</text></svg>`},
        {id:'bea-3',n:'Script',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><text x="60" y="55" text-anchor="middle" font-family="Georgia,serif" font-size="36" font-style="italic" font-weight="700" fill="#1A1A1A">Bea</text><line x1="20" y1="65" x2="100" y2="65" stroke="#1A1A1A" stroke-width="1"/><text x="60" y="82" text-anchor="middle" font-size="8" font-weight="600" fill="#1A1A1A" letter-spacing="5" font-family="sans-serif">COLLECTION 16</text></svg>`}
    ],
    sxm:[
        {id:'sxm-1',n:'Island',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><path d="M60 15 L95 45 L85 95 L35 95 L25 45 Z" stroke="#1A1A1A" stroke-width="2.5" fill="none"/><text x="60" y="58" text-anchor="middle" font-size="22" font-weight="900" fill="#1A1A1A" font-family="sans-serif">SXM</text><text x="60" y="76" text-anchor="middle" font-size="9" font-weight="500" fill="#1A1A1A" letter-spacing="3" font-family="sans-serif">ISLAND</text><text x="60" y="90" text-anchor="middle" font-size="8" fill="#1A1A1A" font-family="sans-serif">— 12 —</text></svg>`},
        {id:'sxm-2',n:'Wave',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><text x="60" y="50" text-anchor="middle" font-size="30" font-weight="900" fill="#1A1A1A" font-family="sans-serif">SXM</text><path d="M20 65 Q35 55 50 65 Q65 75 80 65 Q95 55 100 65" stroke="#1A1A1A" stroke-width="2.5" fill="none"/><path d="M20 78 Q35 68 50 78 Q65 88 80 78 Q95 68 100 78" stroke="#1A1A1A" stroke-width="1.5" fill="none" opacity="0.5"/><text x="60" y="100" text-anchor="middle" font-size="8" font-weight="600" fill="#1A1A1A" letter-spacing="4" font-family="sans-serif">SAINT-MARTIN</text></svg>`},
        {id:'sxm-3',n:'Geo',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="55" r="35" stroke="#1A1A1A" stroke-width="2" fill="none"/><circle cx="60" cy="55" r="25" stroke="#1A1A1A" stroke-width="1.5" fill="none" opacity="0.4"/><text x="60" y="62" text-anchor="middle" font-size="18" font-weight="800" fill="#1A1A1A" font-family="sans-serif">SXM</text><text x="60" y="105" text-anchor="middle" font-size="8" font-weight="600" fill="#1A1A1A" letter-spacing="3" font-family="sans-serif">12 — CARAIBES</text></svg>`}
    ],
    cor:[
        {id:'cor-1',n:'Shield',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><path d="M60 18 L95 35 L95 70 Q95 95 60 108 Q25 95 25 70 L25 35 Z" stroke="#1A1A1A" stroke-width="2.5" fill="none"/><text x="60" y="62" text-anchor="middle" font-size="20" font-weight="900" fill="#1A1A1A" font-family="sans-serif">COR</text><text x="60" y="80" text-anchor="middle" font-size="9" font-weight="500" fill="#1A1A1A" letter-spacing="2" font-family="sans-serif">— 01 —</text></svg>`},
        {id:'cor-2',n:'Typo',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><text x="60" y="45" text-anchor="middle" font-size="40" font-weight="900" fill="#1A1A1A" font-family="sans-serif">C</text><line x1="25" y1="55" x2="95" y2="55" stroke="#1A1A1A" stroke-width="2"/><text x="60" y="72" text-anchor="middle" font-size="11" font-weight="600" fill="#1A1A1A" letter-spacing="8" font-family="sans-serif">CORSICA</text><text x="60" y="92" text-anchor="middle" font-size="9" font-weight="500" fill="#1A1A1A" font-family="sans-serif">Edition 01</text></svg>`},
        {id:'cor-3',n:'Crest',s:`<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><ellipse cx="60" cy="58" rx="42" ry="45" stroke="#1A1A1A" stroke-width="2" fill="none"/><ellipse cx="60" cy="58" rx="35" ry="38" stroke="#1A1A1A" stroke-width="1" fill="none" opacity="0.3"/><text x="60" y="55" text-anchor="middle" font-family="Georgia,serif" font-size="22" font-weight="700" font-style="italic" fill="#1A1A1A">Cor</text><text x="60" y="72" text-anchor="middle" font-size="8" font-weight="600" fill="#1A1A1A" letter-spacing="5" font-family="sans-serif">PREMIERE</text><circle cx="60" cy="85" r="3" fill="#1A1A1A"/></svg>`}
    ]
};

/* ── State ── */
let color = COLORS[0];
let side  = 'front';
let svgF  = null;
let svgB  = null;

/* Per-side logo state (J: Logo Avant, K: Logo Arriere) — logoColor per side */
const logos = {
    front: { data: null, x: 60.5, y: 33, w: 24, h: 17, logoColor: '#1A1A1A' },
    back:  { data: null, x: 47.5, y: 33, w: 24, h: 17, logoColor: '#1A1A1A' }
};
function cl() { return logos[side]; }

let logoSelected = false;
let dragState = null;
let payStatus = 'non';

/* Custom selects registry */
const selects = {};

/* ══════════════════════════════════════
   CUSTOM SELECT COMPONENT
   ══════════════════════════════════════ */
const CHEVRON_SVG = `<svg class="aselect-chevron" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

function createSelect(containerId, options, placeholder, onChange) {
    const container = document.getElementById(containerId);
    const state = { value: '', label: '', onChange: onChange || (() => {}) };

    function render() {
        const isPlaceholder = !state.value;
        container.innerHTML = `
            <div class="aselect-trigger ${isPlaceholder ? 'placeholder' : ''}">${isPlaceholder ? placeholder : state.label}</div>
            ${CHEVRON_SVG}
        `;
        container.querySelector('.aselect-trigger').addEventListener('click', toggle);
    }

    function toggle(e) {
        e.stopPropagation();
        const wasOpen = container.classList.contains('open');
        closeAllSelects();
        if (wasOpen) return;
        container.classList.add('open');

        const dd = document.createElement('div');
        dd.className = 'aselect-dropdown';
        options.forEach(o => {
            if (o.v === '' && o.l === placeholder) return;
            const opt = document.createElement('div');
            opt.className = 'aselect-opt' + (o.v === state.value ? ' on' : '');
            opt.textContent = o.l;
            opt.addEventListener('click', (ev) => {
                ev.stopPropagation();
                state.value = o.v;
                state.label = o.l;
                container.classList.remove('open');
                render();
                state.onChange(o.v);
            });
            dd.appendChild(opt);
        });
        container.appendChild(dd);
    }

    render();
    selects[containerId] = state;
    return state;
}

function closeAllSelects() {
    document.querySelectorAll('.aselect').forEach(s => {
        s.classList.remove('open');
        const dd = s.querySelector('.aselect-dropdown');
        if (dd) dd.remove();
    });
}

function updateSelectOptions(containerId, newOptions, placeholder) {
    const container = document.getElementById(containerId);
    const state = selects[containerId];
    if (!state) return;
    state.value = '';
    state.label = '';

    function renderTrigger() {
        const isPlaceholder = !state.value;
        container.innerHTML = `
            <div class="aselect-trigger ${isPlaceholder ? 'placeholder' : ''}">${isPlaceholder ? placeholder : state.label}</div>
            ${CHEVRON_SVG}
        `;
        container.querySelector('.aselect-trigger').addEventListener('click', toggleDD);
    }

    function toggleDD(e) {
        e.stopPropagation();
        const wasOpen = container.classList.contains('open');
        closeAllSelects();
        if (wasOpen) return;
        container.classList.add('open');

        const dd = document.createElement('div');
        dd.className = 'aselect-dropdown';
        newOptions.forEach(o => {
            const opt = document.createElement('div');
            opt.className = 'aselect-opt' + (o.v === state.value ? ' on' : '');
            opt.textContent = o.l;
            opt.addEventListener('click', (ev) => {
                ev.stopPropagation();
                state.value = o.v;
                state.label = o.l;
                container.classList.remove('open');
                renderTrigger();
                state.onChange(o.v);
            });
            dd.appendChild(opt);
        });
        container.appendChild(dd);
    }

    renderTrigger();
}

/* ══════════════════════════════════════
   RICH SELECT (with HTML options)
   ══════════════════════════════════════ */
function colorDotHtml(hex, name) {
    return '<div style="display:flex;align-items:center;gap:10px;pointer-events:none;"><div style="width:22px;height:22px;border-radius:50%;background:' + hex + ';box-shadow:inset 0 0 0 0.5px rgba(0,0,0,0.12);flex-shrink:0;"></div><span>' + name + '</span></div>';
}

function createRichSelect(containerId, options, placeholder, onChange) {
    const container = document.getElementById(containerId);
    if (!container) return null;
    const state = { value: '', label: '', _html: '', onChange: onChange || (() => {}), _options: options };

    function renderTrigger() {
        const isP = !state.value;
        container.innerHTML = '<div class="aselect-trigger ' + (isP ? 'placeholder' : '') + '">' + (isP ? placeholder : (state._html || state.label)) + '</div>' + CHEVRON_SVG;
        container.querySelector('.aselect-trigger').addEventListener('click', toggle);
    }

    function toggle(e) {
        e.stopPropagation();
        const wasOpen = container.classList.contains('open');
        closeAllSelects();
        if (wasOpen) return;
        container.classList.add('open');
        const dd = document.createElement('div');
        dd.className = 'aselect-dropdown';
        state._options.forEach(o => {
            const opt = document.createElement('div');
            opt.className = 'aselect-opt' + (o.v === state.value ? ' on' : '');
            if (o.html) { opt.innerHTML = o.html; } else { opt.textContent = o.l; }
            opt.addEventListener('click', ev => {
                ev.stopPropagation();
                state.value = o.v; state.label = o.l; state._html = o.trigger || o.html || '';
                container.classList.remove('open');
                renderTrigger();
                state.onChange(o.v);
            });
            dd.appendChild(opt);
        });
        container.appendChild(dd);
    }

    state.reset = function() { state.value = ''; state.label = ''; state._html = ''; renderTrigger(); };
    state.setValue = function(v) {
        const o = state._options.find(x => x.v === v);
        if (o) { state.value = o.v; state.label = o.l; state._html = o.trigger || o.html || ''; renderTrigger(); }
    };

    renderTrigger();
    selects[containerId] = state;
    return state;
}

/* ══════════════════════════════════════
   INIT
   ══════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', async () => {
    const d = new Date();
    const orderDateVal = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    document.getElementById('orderDate').textContent = orderDateVal;
    updateSerial();

    // Build custom selects
    createSelect('selCollection',
        [{v:'Homme',l:'Homme'},{v:'Femme',l:'Femme'},{v:'Enfant',l:'Enfant'},{v:'Accessoire',l:'Accessoire'}],
        'Collection',
        (val) => buildRefs()
    );
    createSelect('selRef', [], 'Reference', () => {});
    createSelect('selSize',
        [{v:'S',l:'S'},{v:'M',l:'M'},{v:'L',l:'L'},{v:'XL',l:'XL'},{v:'XXL',l:'XXL'}],
        'Taille',
        () => {}
    );
    selects['selSize'].value = 'S';
    selects['selSize'].label = 'S';
    document.querySelector('#selSize .aselect-trigger').textContent = 'S';
    document.querySelector('#selSize .aselect-trigger').classList.remove('placeholder');

    // Color dropdown (replaces swatches)
    createRichSelect('selColor',
        COLORS.map(c => ({ v: c.h, l: c.n, html: colorDotHtml(c.h, c.n), trigger: colorDotHtml(c.h, c.n) })),
        'Couleur',
        (val) => {
            const c = COLORS.find(x => x.h === val);
            if (c) { color = c; renderSVG(); }
        }
    );
    selects['selColor'].setValue(COLORS[0].h);

    // Logo interaction — géré directement depuis le t-shirt (bottom sheet)

    initLogoInteraction();

    // Live ID update quand le nom ou le prénom changent
    document.getElementById('clientNom').addEventListener('input', updateSerial);
    document.getElementById('clientPrenom').addEventListener('input', updateSerial);
    updateSerial(); // génère l'ID dès l'ouverture

    // Close selects on outside click
    document.addEventListener('click', () => closeAllSelects());

    try {
        const [f, b] = await Promise.all([
            fetch('tshirt-front.svg').then(r => r.text()),
            fetch('tshirt-back.svg').then(r => r.text())
        ]);
        svgF = f; svgB = b;
    } catch(e) { console.error(e); }

    renderSVG();
});

/* ══════════════════════════════════════
   NAVIGATION
   ══════════════════════════════════════ */
const TITLES = ['Client','Configurateur','Paiement'];

window.go = function(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('s'+n).classList.add('active');
    document.getElementById('hTitle').textContent = TITLES[n-1];
    document.getElementById('hLabel').textContent = `Etape ${n} sur 3`;
    document.getElementById('hNum').textContent = n;
    document.getElementById('hBar').style.width = (n/3*100)+'%';
    if (n === 2) updateSerial();
    window.scrollTo({top:0,behavior:'smooth'});
};

/* ══════════════════════════════════════
   ID — jjmmaa-hhmm-Nom-Prenom
   ══════════════════════════════════════ */
const _orderCreatedAt = new Date(); // heure figée à l'ouverture du formulaire

function updateSerial() {
    const d  = _orderCreatedAt;
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(-2);
    const hh = String(d.getHours()).padStart(2,'0');
    const mi = String(d.getMinutes()).padStart(2,'0');
    const nom    = (document.getElementById('clientNom').value    || '').trim().replace(/\s+/g,'-');
    const prenom = (document.getElementById('clientPrenom').value || '').trim().replace(/\s+/g,'-');
    const namePart = nom && prenom ? `${nom}-${prenom}` : nom || prenom || '…';
    document.getElementById('orderNo').textContent = `${dd}${mm}${yy}-${hh}${mi}-${namePart}`;
}

/* ══════════════════════════════════════
   REFS (H-001, F-001, E-001, A-001...)
   ══════════════════════════════════════ */
window.buildRefs = function() {
    const c = selects['selCollection'] ? selects['selCollection'].value : '';
    const opts = [];
    if (c) {
        const prefix = c[0].toUpperCase();
        for (let i = 1; i <= 5; i++) {
            const code = prefix + '-' + String(i).padStart(3,'0');
            opts.push({v: code, l: code});
        }
    }
    updateSelectOptions('selRef', opts, 'Reference');
};

/* ══════════════════════════════════════
   SVG RENDERING
   ══════════════════════════════════════ */
function renderSide(s) {
    const raw = s === 'front' ? svgF : svgB;
    const box = document.getElementById(s === 'front' ? 'svgBoxFront' : 'svgBoxBack');
    if (!box) return;
    if (!raw) { box.innerHTML = ''; return; }
    box.innerHTML = raw.replace(FABRIC_RE, color.h);
    const el = box.querySelector('svg');
    if (el) {
        el.removeAttribute('width');
        el.removeAttribute('height');
        el.setAttribute('preserveAspectRatio', 'xMidYMid meet');
    }
    renderLogoForSide(s);
}

function renderSVG() {
    renderSide('front');
    renderSide('back');
    document.getElementById('colorName').textContent = color.n;
}

function renderLogoForSide(s) {
    const cur = logos[s];
    const zoneId = s === 'front' ? 'logoZoneFront' : 'logoZoneBack';
    const innerId = s === 'front' ? 'logoInnerFront' : 'logoInnerBack';
    const zone  = document.getElementById(zoneId);
    const inner = document.getElementById(innerId);
    if (!zone || !inner) return;

    // Position toujours à jour
    zone.style.left   = cur.x + '%';
    zone.style.top    = cur.y + '%';
    zone.style.width  = cur.w + '%';
    zone.style.height = cur.h + '%';

    if (!cur.data) {
        inner.innerHTML = '';
        zone.classList.add('empty');
        zone.classList.remove('has-logo', 'selected');
        return;
    }
    zone.classList.remove('empty');
    zone.classList.add('has-logo');
    if (cur.data.type === 'atelier') {
        inner.innerHTML = cur.data.s.replace(/#1A1A1A/gi, cur.logoColor || '#1A1A1A');
    } else {
        inner.innerHTML = `<img src="${cur.data.url}" alt="">`;
    }
}

/* renderLogo — appelé pour rafraîchir les deux côtés */
function renderLogo() {
    renderLogoForSide('front');
    renderLogoForSide('back');
    updateFloatBar();
    updateTapOverlays();
}

function updateLogoPositionForSide(s) {
    const cur  = logos[s];
    const zone = document.getElementById(s === 'front' ? 'logoZoneFront' : 'logoZoneBack');
    if (!zone) return;
    zone.style.left   = cur.x + '%';
    zone.style.top    = cur.y + '%';
    zone.style.width  = cur.w + '%';
    zone.style.height = cur.h + '%';
}

function updateLogoPosition() {
    updateLogoPositionForSide('front');
    updateLogoPositionForSide('back');
}

/* ══════════════════════════════════════
   SYNC LOGO UI (on side flip)
   ══════════════════════════════════════ */
function syncLogoUI() {
    const cur = cl();
    // Upload pill dans le sheet
    if (cur.data && cur.data.type === 'custom') {
        document.getElementById('upThumb').src = cur.data.url;
        document.getElementById('upName').textContent = cur.data.name || 'Custom';
        document.getElementById('upPill').classList.add('show');
    } else {
        document.getElementById('upPill').classList.remove('show');
        const fi = document.getElementById('fileIn');
        if (fi) fi.value = '';
    }
    updateFloatBar();
    updateTapOverlays();
}

/* ══════════════════════════════════════
   LOGO INTERACTION — 2 zones indépendantes
   ══════════════════════════════════════ */
/* Pinch state (2 doigts sur le logo) */
let pinchState = null;

function initLogoInteraction() {
    ['front', 'back'].forEach(s => {
        const zoneId = s === 'front' ? 'logoZoneFront' : 'logoZoneBack';
        const viewId = s === 'front' ? 'svgViewFront'  : 'svgViewBack';
        const zone   = document.getElementById(zoneId);
        const view   = document.getElementById(viewId);
        if (!zone || !view) return;

        zone.addEventListener('pointerdown', e => onLogoDown(e, s));

        /* Curseur dynamique : coins = resize, centre = move */
        zone.addEventListener('pointermove', e => {
            if (dragState) return; // pas de mise à jour pendant le drag
            if (!logos[s].data) return;
            const zr = zone.getBoundingClientRect();
            const rx = (e.clientX - zr.left)  / zr.width;
            const ry = (e.clientY - zr.top)   / zr.height;
            const EDGE = 0.35;
            const corner = (rx < EDGE || rx > 1 - EDGE) && (ry < EDGE || ry > 1 - EDGE);
            if (corner) {
                const cx = rx > 0.5 ? 'e' : 'w';
                const cy = ry > 0.5 ? 's' : 'n';
                const cursors = { nw:'nwse-resize', ne:'nesw-resize', sw:'nesw-resize', se:'nwse-resize' };
                zone.style.cursor = cursors[cy + cx];
            } else {
                zone.style.cursor = 'move';
            }
        });

        /* ── Pinch-to-zoom sur toute la zone SVG (2 doigts = resize diagonal) ── */
        view.addEventListener('touchstart', e => {
            if (e.touches.length === 2 && logos[s].data) {
                e.preventDefault();
                if (side !== s) flipSide(s);
                const d = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                pinchState = { side: s, startDist: d, origW: logos[s].w, origH: logos[s].h };
            }
        }, { passive: false });

        view.addEventListener('touchmove', e => {
            if (!pinchState || pinchState.side !== s || e.touches.length < 2) return;
            e.preventDefault();
            const d = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            const scale = d / pinchState.startDist;
            const ratio = pinchState.origH / pinchState.origW;
            let newW = pinchState.origW * scale;
            let newH = newW * ratio;
            /* Contraindre en gardant le ratio */
            if (newW < 8)  { newW = 8;  newH = newW * ratio; }
            if (newW > 50) { newW = 50; newH = newW * ratio; }
            if (newH < 6)  { newH = 6;  newW = newH / ratio; }
            if (newH > 40) { newH = 40; newW = newH / ratio; }
            logos[s].w = newW;
            logos[s].h = newH;
            updateLogoPositionForSide(s);
        }, { passive: false });

        view.addEventListener('touchend', () => { pinchState = null; });
    });

    document.addEventListener('pointermove', onLogoMove);
    document.addEventListener('pointerup',   onLogoUp);

    // Désélection globale
    document.addEventListener('pointerdown', e => {
        if (!e.target.closest('.logo-zone') && !e.target.closest('.logo-tap-overlay')) {
            logoSelected = false;
            document.querySelectorAll('.logo-zone').forEach(z => z.classList.remove('selected'));
        }
    });

    // Tap overlay → ouvre le bottom sheet de sélection logo
    const tapF = document.getElementById('logoTapFront');
    const tapB = document.getElementById('logoTapBack');
    if (tapF) tapF.addEventListener('click', () => { flipSide('front'); openLogoSheet('front'); });
    if (tapB) tapB.addEventListener('click', () => { flipSide('back');  openLogoSheet('back');  });


}

function onLogoDown(e, activeSide) {
    const cur = logos[activeSide];
    if (!cur.data) return;
    e.preventDefault();
    e.stopPropagation();

    /* Activer ce côté pour les sélecteurs */
    if (side !== activeSide) {
        side = activeSide;
        // Désélectionner tous les logos (évite cadre bleu fantôme sur l'autre côté)
        document.querySelectorAll('.logo-zone').forEach(z => z.classList.remove('selected'));
        logoSelected = false;
        document.getElementById('colFront').classList.toggle('active', side === 'front');
        document.getElementById('colBack').classList.toggle('active',  side === 'back');
        syncLogoUI();
    }

    const zoneId = activeSide === 'front' ? 'logoZoneFront' : 'logoZoneBack';
    const viewId = activeSide === 'front' ? 'svgViewFront'  : 'svgViewBack';
    const zone   = document.getElementById(zoneId);
    const rect   = document.getElementById(viewId).getBoundingClientRect();

    logoSelected = true;
    zone.classList.add('selected');

    /* Détection positionnelle : coins = resize diagonal, centre = déplacement */
    const zoneRect = zone.getBoundingClientRect();
    const relX = (e.clientX - zoneRect.left) / zoneRect.width;
    const relY = (e.clientY - zoneRect.top)  / zoneRect.height;
    const EDGE = 0.35;
    const inCorner = (relX < EDGE || relX > 1 - EDGE) && (relY < EDGE || relY > 1 - EDGE);

    if (inCorner) {
        const cornerX = relX > 0.5 ? 'e' : 'w';
        const cornerY = relY > 0.5 ? 's' : 'n';
        dragState = {
            type: 'resize', side: activeSide,
            corner: cornerY + cornerX,
            startX: e.clientX, startY: e.clientY,
            origW: cur.w, origH: cur.h, origX: cur.x, origY: cur.y,
            stageW: rect.width, stageH: rect.height
        };
    } else {
        dragState = {
            type: 'drag', side: activeSide,
            startX: e.clientX, startY: e.clientY,
            origX: cur.x, origY: cur.y,
            stageW: rect.width, stageH: rect.height
        };
    }
    zone.setPointerCapture(e.pointerId);
}

function onLogoMove(e) {
    if (!dragState) return;
    e.preventDefault();
    const cur = logos[dragState.side];
    const s   = dragState.side;

    if (dragState.type === 'drag') {
        const dx = e.clientX - dragState.startX;
        const dy = e.clientY - dragState.startY;
        cur.x = dragState.origX + (dx / dragState.stageW) * 100;
        cur.y = dragState.origY + (dy / dragState.stageH) * 100;
        cur.x = Math.max(cur.w / 2, Math.min(100 - cur.w / 2, cur.x));
        cur.y = Math.max(5, Math.min(95, cur.y));
        requestAnimationFrame(() => updateLogoPositionForSide(s));
    }

    if (dragState.type === 'resize') {
        /* Apple-style : coin direct, linéaire, ratio toujours conservé */
        const dx = e.clientX - dragState.startX;
        const dy = e.clientY - dragState.startY;
        const signX = dragState.corner.includes('e') ? 1 : -1;
        const signY = dragState.corner.includes('s') ? 1 : -1;
        const delta  = (signX * dx + signY * dy) * 0.5;
        const pctChg = (delta / dragState.stageW) * 100 * 2.5;
        const ratio  = dragState.origH / dragState.origW;
        let nw = dragState.origW + pctChg;
        let nh = nw * ratio;
        if (nw < 8)  { nw = 8;  nh = nw * ratio; }
        if (nw > 50) { nw = 50; nh = nw * ratio; }
        if (nh < 6)  { nh = 6;  nw = nh / ratio; }
        if (nh > 40) { nh = 40; nw = nh / ratio; }
        cur.w = nw; cur.h = nh;
        requestAnimationFrame(() => updateLogoPositionForSide(s));
    }
}

function onLogoUp(e) {
    dragState = null;
}

/* ══════════════════════════════════════
   SIDE TOGGLE
   ══════════════════════════════════════ */
window.flipSide = function(s) {
    side = s;
    logoSelected = false;
    document.querySelectorAll('.logo-zone').forEach(z => z.classList.remove('selected'));
    document.getElementById('colFront').classList.toggle('active', s === 'front');
    document.getElementById('colBack').classList.toggle('active',  s === 'back');
    syncLogoUI();
};

function showLogoColorSection() { /* géré par le bottom sheet */ }

window.dropLogo = function() {
    const cur = cl();
    cur.data = null;
    logoSelected = false;
    document.getElementById('upPill').classList.remove('show');
    const fi = document.getElementById('fileIn'); if (fi) fi.value = '';
    renderLogo();
    updateFloatBar();
    updateTapOverlays();
};

/* ══════════════════════════════════════
   FILE UPLOAD
   ══════════════════════════════════════ */
window.onUpload = function(e) {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = function(ev) {
        const cur = cl();
        cur.data = {type:'custom', url:ev.target.result, name:f.name};
        document.getElementById('upThumb').src = ev.target.result;
        document.getElementById('upName').textContent = f.name;
        document.getElementById('upPill').classList.add('show');
        cur.x = side === 'front' ? 60.5 : 47.5;
        cur.y = 33; cur.w = 24; cur.h = 17;
        renderLogo();
        closeLogoSheet();
    };
    r.readAsDataURL(f);
};

window.rmUpload = function() {
    const cur = cl();
    if (cur.data && cur.data.type === 'custom') { cur.data = null; renderLogo(); }
    document.getElementById('upPill').classList.remove('show');
    const fi = document.getElementById('fileIn'); if (fi) fi.value = '';
};

/* ══════════════════════════════════════
   TAP OVERLAYS — état vide/rempli
   ══════════════════════════════════════ */
function updateTapOverlays() {
    ['front', 'back'].forEach(s => {
        const id = s === 'front' ? 'logoTapFront' : 'logoTapBack';
        const el = document.getElementById(id);
        if (!el) return;
        if (logos[s].data) { el.classList.add('gone'); }
        else               { el.classList.remove('gone'); }
    });
}

/* ══════════════════════════════════════
   FLOAT BAR — barre contextuelle logo
   ══════════════════════════════════════ */
function updateFloatBar() {
    const bar = document.getElementById('logoFloatBar');
    if (!bar) return;
    const cur = logos[side];
    if (!cur.data) { bar.style.display = 'none'; return; }
    bar.style.display = 'flex';
}

/* ══════════════════════════════════════
   LOGO BOTTOM SHEET
   ══════════════════════════════════════ */
let _sheetSide = 'front';

function buildSheetLogoGrid() {
    const grid = document.getElementById('lsheetLogoGrid');
    if (!grid) return;
    grid.innerHTML = '';
    const cur = logos[_sheetSide];
    Object.entries(LOGOS).forEach(([k, arr]) => {
        const label = document.createElement('div');
        label.className = 'lsheet-group-label';
        label.textContent = k === 'bea' ? 'BEA — 16' : k === 'sxm' ? 'SXM — 12' : 'COR — 01';
        grid.appendChild(label);
        const g = document.createElement('div');
        g.className = 'lsheet-logo-grid';
        arr.forEach(l => {
            const thumb = document.createElement('div');
            thumb.className = 'lsheet-thumb' + (cur.data && cur.data.id === l.id ? ' on' : '');
            const svgContainer = document.createElement('div');
            svgContainer.innerHTML = l.s;
            const svgEl = svgContainer.querySelector('svg');
            if (svgEl) { svgEl.setAttribute('width','56'); svgEl.setAttribute('height','56'); }
            const nameEl = document.createElement('div');
            nameEl.className = 'lsheet-thumb-name';
            nameEl.textContent = l.n;
            if (svgEl) thumb.appendChild(svgEl);
            thumb.appendChild(nameEl);
            thumb.addEventListener('click', () => {
                cur.data = { type: 'atelier', id: l.id, s: l.s };
                cur.x = _sheetSide === 'front' ? 60.5 : 47.5;
                cur.y = 33; cur.w = 24; cur.h = 17;
                renderLogo();
                updateSheetColorSection();
                buildSheetLogoGrid();
                closeLogoSheet();
            });
            g.appendChild(thumb);
        });
        grid.appendChild(g);
    });
}

function buildSheetColorRow() {
    const row = document.getElementById('lsheetColorRow');
    if (!row) return;
    const cur = logos[_sheetSide];
    row.innerHTML = '';
    LOGO_COLORS.forEach(c => {
        const dot = document.createElement('button');
        dot.className = 'lsheet-color-dot' + (cur.logoColor === c.h ? ' on' : '');
        dot.style.background = c.h;
        dot.title = c.n;
        dot.addEventListener('click', () => {
            cur.logoColor = c.h;
            renderLogoForSide('front');
            renderLogoForSide('back');
            updateFloatBar();
            buildSheetColorRow();
        });
        row.appendChild(dot);
    });
}

function updateSheetColorSection() {
    const sec = document.getElementById('lsheetColorSection');
    if (!sec) return;
    const cur = logos[_sheetSide];
    if (cur.data && cur.data.type === 'atelier') {
        sec.classList.add('visible');
        buildSheetColorRow();
    } else {
        sec.classList.remove('visible');
    }
}

window.openLogoSheet = function(s) {
    _sheetSide = (s !== undefined) ? s : side;
    document.getElementById('lsheetTitle').textContent = _sheetSide === 'front' ? 'Logo Avant' : 'Logo Arrière';
    buildSheetLogoGrid();
    updateSheetColorSection();
    document.getElementById('lsheet').classList.add('open');
    document.getElementById('lsheetBackdrop').classList.add('open');
};

window.closeLogoSheet = function() {
    document.getElementById('lsheet').classList.remove('open');
    document.getElementById('lsheetBackdrop').classList.remove('open');
};

/* ══════════════════════════════════════
   PAYMENT
   ══════════════════════════════════════ */
window.setPay = function(s) {
    payStatus = s;
    document.querySelectorAll('#payStatus .pay-opt').forEach(b => b.classList.toggle('on', b.dataset.p === s));
};

window.calcTotal = function() {
    const t = (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0);
    document.getElementById('totalLabel').innerHTML = t + ' &euro;';
};

/* ══════════════════════════════════════
   MOCKUP CAPTURE — renders a side (front/back) to a JPEG data-URL
   ══════════════════════════════════════ */
function renderSvgToImg(svgStr, w, h) {
    return new Promise(function(resolve) {
        var blob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
        var url = URL.createObjectURL(blob);
        var img = new Image();
        img.onload = function() { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = function() { URL.revokeObjectURL(url); resolve(null); };
        img.src = url;
    });
}

async function captureMockup(shirtSvg, sideData, fabricHex, W, H, Q) {
    W = W || 400; H = H || 480; Q = Q || 0.65;
    var c = document.createElement('canvas'); c.width = W; c.height = H;
    var cx = c.getContext('2d');
    cx.fillStyle = '#F5F5F7'; cx.fillRect(0, 0, W, H);

    if (shirtSvg) {
        var colored = shirtSvg.replace(FABRIC_RE, fabricHex);
        var shirtImg = await renderSvgToImg(colored, W, H);
        if (shirtImg) {
            var scale = Math.min(W / shirtImg.naturalWidth, H / shirtImg.naturalHeight) * 0.92;
            var sw = shirtImg.naturalWidth * scale, sh = shirtImg.naturalHeight * scale;
            cx.drawImage(shirtImg, (W - sw) / 2, (H - sh) / 2, sw, sh);
        }
    }

    /* Overlay logo */
    if (sideData && sideData.data) {
        var lx = (sideData.x / 100) * W, ly = (sideData.y / 100) * H;
        var lw = (sideData.w / 100) * W, lh = (sideData.h / 100) * H;
        var logoImg = null;
        if (sideData.data.type === 'atelier' && sideData.data.s) {
            var logoSvg = sideData.data.s.replace(/#1A1A1A/gi, sideData.logoColor || '#1A1A1A');
            logoImg = await renderSvgToImg(logoSvg, lw, lh);
        } else if (sideData.data.type === 'custom' && sideData.data.url) {
            logoImg = await new Promise(function(resolve) {
                var im = new Image(); im.onload = function() { resolve(im); };
                im.onerror = function() { resolve(null); }; im.src = sideData.data.url;
            });
        }
        if (logoImg) cx.drawImage(logoImg, lx - lw / 2, ly - lh / 2, lw, lh);
    }

    return c.toDataURL('image/jpeg', Q);
}

/* ══════════════════════════════════════
   SUBMIT  (A-Q payload)
   ══════════════════════════════════════ */
window.submit = async function() {
    const b = document.getElementById('subBtn');
    b.textContent = 'Envoi...'; b.disabled = true; b.style.opacity = '0.6';

    try {

    /* ── Build payload ── */
    const collVal = selects['selCollection'] ? selects['selCollection'].value : '';
    const refVal  = selects['selRef']        ? selects['selRef'].value        : '';
    const sizeVal = selects['selSize']       ? selects['selSize'].value       : '';

    const tel = document.getElementById('clientPhone').value || '';

    const logoColorName = (hex, arr) => (arr.find(c => c.h === hex) || { n: hex }).n;

    const payload = {
        commande          : document.getElementById('orderNo').textContent.trim(),
        date              : document.getElementById('orderDate').textContent.trim(),
        nom               : (document.getElementById('clientNom').value.trim() + ' ' +
                             document.getElementById('clientPrenom').value.trim()).trim(),
        telephone         : tel.trim(),
        collection        : collVal || '',
        reference         : refVal  || '',
        taille            : sizeVal || '',
        couleurTshirt     : color.n,
        couleurTshirtHex  : color.h,
        couleurLogoAvant  : logos.front.data && logos.front.data.type === 'atelier'
                            ? logoColorName(logos.front.logoColor, LOGO_COLORS) : '',
        couleurLogoArriere: logos.back.data  && logos.back.data.type  === 'atelier'
                            ? logoColorName(logos.back.logoColor,  LOGO_COLORS) : '',
        logoAvant         : logos.front.data ? (logos.front.data.type === 'atelier' ? logos.front.data.id : 'Custom') : '',
        logoArriere       : logos.back.data  ? (logos.back.data.type  === 'atelier' ? logos.back.data.id  : 'Custom') : '',
        note              : (document.getElementById('note').value || '').trim(),
        prixTshirt        : document.getElementById('price').value        || '0',
        personnalisation  : document.getElementById('customPrice').value  || '0',
        total             : document.getElementById('totalLabel').textContent.trim(),
        paye              : payStatus === 'oui' ? 'OUI' : 'NON'
    };

    /* ── Capture mockups réduits (220×264, JPEG 0.48) pour la fiche atelier ── */
    var mockupFront = await captureMockup(svgF, logos.front, color.h, 220, 264, 0.48);
    var mockupBack  = await captureMockup(svgB, logos.back,  color.h, 220, 264, 0.48);

    /* ── Build fiche URL (~150 Ko avec images compressées) ── */
    const ATELIER_URL = 'https://ficheatelier.pages.dev';
    const ficheData = {
        commande          : payload.commande,
        date              : payload.date,
        nom               : payload.nom,
        telephone         : payload.telephone,
        collection        : payload.collection,
        reference         : payload.reference,
        taille            : payload.taille,
        couleur           : { nom: color.n, hex: color.h },
        logoAvant         : payload.logoAvant,
        logoArriere       : payload.logoArriere,
        couleurLogoAvant  : payload.couleurLogoAvant,
        couleurLogoArriere: payload.couleurLogoArriere,
        note              : payload.note,
        prix              : { tshirt: payload.prixTshirt, personnalisation: payload.personnalisation, total: payload.total },
        paiement          : { statut: payload.paye },
        mockupFront       : mockupFront,
        mockupBack        : mockupBack
    };
    const ficheURL = ATELIER_URL + '#' + btoa(unescape(encodeURIComponent(JSON.stringify(ficheData))));

    /* URL complète avec mockups — setLinkUrl (RichText) n'a pas de limite de formule */
    payload.fiche = ficheURL;

    /* ── Envoi Google Sheets (best-effort, non-bloquant) ── */
    fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }).catch(() => {});

    /* ── Apple success overlay ── */
    const overlay = document.getElementById('successOverlay');
    document.getElementById('sfOrderNo').textContent    = payload.commande;
    document.getElementById('sfClientName').textContent = payload.nom || '';
    document.getElementById('sfFicheBtn').onclick = () => window.open(ficheURL, '_blank');
    overlay.classList.add('sf-on');

    } catch(e) {
        console.error('Erreur validation:', e);
        b.textContent = 'Valider la Commande'; b.disabled = false; b.style.opacity = '1';
        /* Affichage erreur discret */
        const err = document.createElement('p');
        err.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#FF3B30;color:#fff;padding:12px 20px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;';
        err.textContent = 'Erreur : ' + e.message;
        document.body.appendChild(err);
        setTimeout(() => err.remove(), 5000);
    }
};

})();
</script>

</body>
</html>
