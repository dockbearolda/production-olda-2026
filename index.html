<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio T-Shirt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --apple-blue: #007AFF; --apple-bg: #F5F5F7; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--apple-bg); -webkit-font-smoothing: antialiased; }
        
        /* UI Components */
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); overflow: hidden; }
        .ios-input { background: #f2f2f7; border: none; border-radius: 12px; padding: 14px; font-size: 16px; width: 100%; outline: none; }
        .ios-input:read-only { background: #e5e5ea; color: #8e8e93; cursor: not-allowed; }
        .ios-btn { background: var(--apple-blue); color: white; border-radius: 14px; padding: 16px; font-size: 17px; font-weight: 600; text-align: center; width: 100%; border: none; }
        .ios-btn:active { transform: scale(0.98); opacity: 0.9; }
        
        /* Color Swatches */
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; }
        .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 2px solid transparent; cursor: pointer; position: relative; transition: transform 0.2s; }
        .color-swatch.active { border-color: var(--apple-blue); transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .color-swatch.active::after { content: '✓'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        /* Navigation */
        .step-container { display: none; flex-direction: column; gap: 15px; animation: fadeIn 0.3s ease-out; }
        .step-container.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 700; color: #8e8e93; transition: all 0.2s; }
        .tab-btn.active { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); color: var(--apple-blue); }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 pb-10">

    <div class="max-w-md mx-auto w-full mb-4 pt-2">
        <div class="flex justify-between items-end mb-2">
            <div>
                <p id="step-label" class="text-[11px] font-black text-blue-500 uppercase tracking-widest mb-1">ÉTAPE 1 / 4</p>
                <h1 id="step-title" class="text-3xl font-bold text-gray-900 tracking-tight">Client</h1>
            </div>
            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 font-bold text-sm" id="step-badge">1</div>
        </div>
        <div class="h-1.5 w-full bg-gray-200 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-blue-500 w-1/4 transition-all duration-500 ease-out"></div>
        </div>
    </div>

    <div class="max-w-md mx-auto w-full flex-grow">

        <div id="step-1" class="step-container active">
            <div class="ios-card p-5 space-y-4">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">N° Commande</label>
                    <input type="text" id="orderNo" class="ios-input font-mono text-gray-500" readonly>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nom du Client</label>
                    <input type="text" id="clientName" class="ios-input" placeholder="Nom complet">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Téléphone</label>
                    <input type="tel" id="clientPhone" class="ios-input" placeholder="06...">
                </div>
            </div>
            <button onclick="nav(2)" class="ios-btn mt-2 shadow-lg shadow-blue-200">Continuer</button>
        </div>

        <div id="step-2" class="step-container">
            <div class="ios-card p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Collection</label>
                        <select id="collection" class="ios-input">
                            <option>Homme</option><option>Femme</option><option>Enfant</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Taille</label>
                        <select id="size" class="ios-input">
                            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
                        </select>
                    </div>
                </div>
                
                <div class="pt-2">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Couleur T-Shirt</label>
                    <div class="color-grid" id="tshirt-palette">
                        </div>
                    <p id="selected-tshirt-name" class="text-center text-xs font-semibold text-gray-500 mt-2">Blanc</p>
                </div>

                <div class="pt-2 border-t">
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Couleur Logo</label>
                    <div class="color-grid" id="logo-palette">
                        </div>
                    <p id="selected-logo-name" class="text-center text-xs font-semibold text-gray-500 mt-2">Noir</p>
                </div>
            </div>
            
            <div class="flex gap-3 mt-2">
                <button onclick="nav(1)" class="ios-btn bg-gray-200 !text-gray-600">Retour</button>
                <button onclick="nav(3)" class="ios-btn shadow-lg shadow-blue-200">Design</button>
            </div>
        </div>

        <div id="step-3" class="step-container">
            <div class="bg-gray-200 p-1 rounded-xl flex mb-2">
                <button id="btn-av" onclick="setSide('front')" class="tab-btn active">AVANT</button>
                <button id="btn-ar" onclick="setSide('back')" class="tab-btn">ARRIÈRE</button>
            </div>
            
            <div class="flex justify-center bg-white rounded-3xl p-2 shadow-inner border border-gray-100 relative">
                <canvas id="c" width="300" height="360"></canvas>
            </div>

            <div class="ios-card p-4 space-y-3">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase px-1">Sélectionner Logo</label>
                    <select id="logoSelect" class="ios-input" onchange="applyLogo(this.value)">
                        <option value="">-- Aucun --</option>
                        <option value="AVI-01">AVI-01</option>
                        <option value="SXM-12">SXM-12</option>
                        <option value="BEA-16">BEA-16</option>
                        <option value="LION-03">LION-03</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase px-1">Note</label>
                    <textarea id="note" class="ios-input h-14 text-sm" placeholder="Remarques..."></textarea>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="nav(2)" class="ios-btn bg-gray-200 !text-gray-600">Retour</button>
                <button onclick="nav(4)" class="ios-btn shadow-lg shadow-blue-200">Finances</button>
            </div>
        </div>

        <div id="step-4" class="step-container">
            <div class="ios-card p-5 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Prix Unit.</label>
                        <div class="relative">
                            <input type="number" id="price" class="ios-input pl-8 font-bold" value="25" oninput="updateTotal()">
                            <span class="absolute left-3 top-3.5 text-gray-400">€</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Perso</label>
                        <div class="relative">
                            <input type="number" id="customPrice" class="ios-input pl-8 font-bold" value="0" oninput="updateTotal()">
                            <span class="absolute left-3 top-3.5 text-gray-400">€</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-5 rounded-2xl text-white flex justify-between items-center shadow-xl shadow-gray-300">
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase mb-1">Total à payer</p>
                        <p id="totalLabel" class="text-4xl font-black tracking-tighter">25 €</p>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-gray-400 uppercase px-1">Statut Paiement</label>
                    <select id="paid" class="ios-input bg-green-50 text-green-700 font-semibold border border-green-100">
                        <option value="NON">❌ Non Payé</option>
                        <option value="OUI">✅ Payé</option>
                    </select>
                </div>
            </div>

            <button onclick="submit()" id="submitBtn" class="ios-btn bg-green-500 shadow-lg shadow-green-300 mt-2">Valider la Commande</button>
            <button onclick="nav(3)" class="text-center text-gray-400 text-sm font-medium w-full py-2">Retour au design</button>
        </div>

    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxXM44btJkr0IrX6bG1Jw07iku9Uq_boToCpfTEWJSlFaE_QL-YDiBflPsCYWz4E8ck/exec";
        
        // TRACÉS SVG
        const PATH_FRONT = "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 178,42 150,52 140,52 C 130,52 102,42 93,23 Z";
        const PATH_BACK = "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 182,28 165,33 140,33 C 115,33 98,28 93,23 Z";

        // PALETTE DE 10 COULEURS
        const COLORS = [
            { name: "Blanc", hex: "#FFFFFF", border: "#e5e7eb" },
            { name: "Noir", hex: "#1c1c1e", border: "#1c1c1e" },
            { name: "Gris", hex: "#9ca3af", border: "#9ca3af" },
            { name: "Bleu Marine", hex: "#1e3a8a", border: "#1e3a8a" },
            { name: "Bleu Royal", hex: "#2563eb", border: "#2563eb" },
            { name: "Ciel", hex: "#60a5fa", border: "#60a5fa" },
            { name: "Rouge", hex: "#dc2626", border: "#dc2626" },
            { name: "Vert", hex: "#15803d", border: "#15803d" },
            { name: "Jaune", hex: "#facc15", border: "#facc15" },
            { name: "Rose", hex: "#f472b6", border: "#f472b6" }
        ];

        let state = {
            tshirtColor: COLORS[0], // Par défaut Blanc
            logoColor: COLORS[1],   // Par défaut Noir
            side: 'front',
            objects: { front: { logo: null }, back: { logo: null } }
        };

        let canvas;

        window.onload = () => {
            generateOrderNo();
            initPalettes();
            canvas = new fabric.Canvas('c', { selection: false });
            drawTshirt();
        };

        function generateOrderNo() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth()+1).padStart(2,'0');
            const d = String(now.getDate()).padStart(2,'0');
            const h = String(now.getHours()).padStart(2,'0');
            const min = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('orderNo').value = `${y}-${m}${d}-${h}${min}`;
        }

        function initPalettes() {
            const tsContainer = document.getElementById('tshirt-palette');
            const lgContainer = document.getElementById('logo-palette');
            
            COLORS.forEach((c, idx) => {
                // T-SHIRT PALETTE
                const dotT = document.createElement('div');
                dotT.className = `color-swatch ${idx===0?'active':''}`;
                dotT.style.backgroundColor = c.hex;
                dotT.style.borderColor = c.name === 'Blanc' ? '#ccc' : c.hex;
                dotT.onclick = () => selectColor('tshirt', c, dotT);
                tsContainer.appendChild(dotT);

                // LOGO PALETTE
                const dotL = document.createElement('div');
                dotL.className = `color-swatch ${idx===1?'active':''}`;
                dotL.style.backgroundColor = c.hex;
                dotL.style.borderColor = c.name === 'Blanc' ? '#ccc' : c.hex;
                dotL.onclick = () => selectColor('logo', c, dotL);
                lgContainer.appendChild(dotL);
            });
        }

        function selectColor(type, colorObj, el) {
            // UI Update
            const container = type === 'tshirt' ? document.getElementById('tshirt-palette') : document.getElementById('logo-palette');
            Array.from(container.children).forEach(child => child.classList.remove('active'));
            el.classList.add('active');
            
            // Text Update
            document.getElementById(`selected-${type}-name`).innerText = colorObj.name;

            // State Update
            if (type === 'tshirt') state.tshirtColor = colorObj;
            else state.logoColor = colorObj;

            // Re-render Canvas immediately
            drawTshirt();
            // Re-apply logo color if logo exists
            const currentLogo = state.objects[state.side].logo;
            if(currentLogo && currentLogo.set) {
                currentLogo.set('fill', state.logoColor.hex);
                canvas.renderAll();
            }
        }

        function drawTshirt() {
            canvas.clear();
            const hex = state.tshirtColor.hex;
            const stroke = state.tshirtColor.name === 'Blanc' ? '#e5e7eb' : '#333';
            
            const pathString = (state.side === 'front') ? PATH_FRONT : PATH_BACK;
            
            const tshirt = new fabric.Path(pathString, {
                fill: hex, stroke: stroke, strokeWidth: 1.5,
                selectable: false, evented: false, originX: 'center', originY: 'center', top: 180, left: 150
            });
            canvas.add(tshirt);

            // Add Logo if exists
            const logo = state.objects[state.side].logo;
            if(logo) canvas.add(logo);
            canvas.renderAll();
        }

        function setSide(s) {
            state.side = s;
            document.getElementById('btn-av').className = s === 'front' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('btn-ar').className = s === 'back' ? 'tab-btn active' : 'tab-btn';
            
            // Sync Logo Select value
            const obj = state.objects[s].logo;
            document.getElementById('logoSelect').value = obj ? obj.text : "";
            
            drawTshirt();
        }

        function applyLogo(val) {
            // Remove old
            if (state.objects[state.side].logo) {
                canvas.remove(state.objects[state.side].logo);
                state.objects[state.side].logo = null;
            }

            if(!val) { canvas.renderAll(); return; }

            const txt = new fabric.Text(val, { 
                left: 150, top: 130, fontSize: 22, 
                fontFamily: 'Helvetica', fontWeight: 'bold',
                fill: state.logoColor.hex, // Use selected logo color
                originX: 'center', originY: 'center',
                cornerColor: '#007AFF', transparentCorners: false, cornerSize: 8
            });

            state.objects[state.side].logo = txt;
            canvas.add(txt);
            canvas.setActiveObject(txt);
            canvas.renderAll();
        }

        function updateTotal() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            const c = parseFloat(document.getElementById('customPrice').value) || 0;
            document.getElementById('totalLabel').innerText = (p + c) + " €";
        }

        function nav(step) {
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.getElementById('step-'+step).classList.add('active');
            
            document.getElementById('step-label').innerText = `ÉTAPE ${step} / 4`;
            document.getElementById('step-badge').innerText = step;
            document.getElementById('progress-bar').style.width = (step * 25) + '%';
            
            const titles = ["Client", "Détails", "Design", "Finances"];
            document.getElementById('step-title').innerText = titles[step-1];
            window.scrollTo(0,0);
        }

        function submit() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "Envoi...";

            const payload = {
                orderNo: document.getElementById('orderNo').value,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                collection: document.getElementById('collection').value,
                size: document.getElementById('size').value,
                tshirtColor: state.tshirtColor.name,
                logoColor: state.logoColor.name,
                logoFront: state.objects.front.logo ? state.objects.front.logo.text : '',
                logoBack: state.objects.back.logo ? state.objects.back.logo.text : '',
                note: document.getElementById('note').value,
                price: document.getElementById('price').value,
                customPrice: document.getElementById('customPrice').value,
                total: (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0),
                paid: document.getElementById('paid').value,
                image: canvas.toDataURL({ format: 'png', multiplier: 1 })
            };

            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
            .then(() => {
                alert("✅ Commande enregistrée avec succès !");
                location.reload();
            })
            .catch(err => {
                alert("Erreur");
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
